<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="robots" content="noindex" />
    <title>Web Midi Link Test</title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != 'dataLayer' ? '&l=' + l : '';
        j.async = true;
        j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, 'script', 'dataLayer', 'UA-33600926-1');
    </script>
    <!-- End Google Tag Manager -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@logue/sf2synth@0.4.6/dist/style.css"
      integrity="sha256-7nkFBu7RfHUUCk66cKrXm1sfD2tu+duFCCWun+L2Emg="
      crossorigin="anonymous"
    />
  </head>

  <body>
    <div class="container-fluid">
      <header>
        <h1 class="h2">
          SoundFont:
          <span id="soundfont"></span>
        </h1>
        <p class="text-end">
          <a href="https://logue.dev/" target="_blank">Logue</a>
          /
          <small class="text-muted">
            Last Modified:
            <span id="build"></span>
          </small>
        </p>
      </header>
      <main>
        <div>
          <label class="form-label" for="file">
            Load SoundFont2 file
            <small class="text-muted">
              (drag and drop here *.sf2 file to change sound font)
            </small>
          </label>
          <input
            type="file"
            class="form-control"
            id="file"
            accept="audio/x-soundfont"
          />
        </div>
        <hr />
        <div id="placeholder"></div>
      </main>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/query-string@1.0.1/query-string.js"
      integrity="sha256-grrS5HRy2p4Z2sCglfc9r6rqRBewKCdWzuWhbUpIEJ4="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@logue/sf2synth@0.4.6/dist/sf2synth.umd.js"
      integrity="sha256-cx2AotBALN0NPhxO5Gq+PJHS3Etfpl0bdI7YxBGAjto="
      crossorigin="anonymous"
    ></script>
    <script>
      /** Query string */
      const qs = queryString.parse(window.location.search);
      /** sf2synth.js Option */
      const option = { placeholder: 'placeholder' };
      if (qs.ui === 'false') {
        option.drawSynth = false;
      }

      window.onload = () => {
        /** WebMidiLink */
        const wml = new SoundFont.WebMidiLink(option);
        /** Message DOM */
        const message = document.getElementById('message');
        /** File Input Form */
        const fileInput = document.getElementById('file');
        /** Placeholder */
        const placeholder = document.getElementById('placeholder');

        /** SoundFont file */
        const sf = qs.soundfont
          ? decodeURIComponent(qs.soundfont)
          : 'Yamaha XG Sound Set Ver.2.0.sf2';

        document.getElementById('soundfont').innerText = sf;

        document.getElementById('build').innerText = new Date(
          wml.build
        ).toLocaleString();
        wml.setLoadCallback(() => {
          // message.style.display = 'none';
        });
        wml.setup(sf);

        // Load sound font
        const handleSoundFont = file => {
          const reader = new FileReader();

          // wml.cancelLoading();

          reader.readAsArrayBuffer(file);

          reader.onload = e => {
            console.log('loaded', file);
            document.getElementById('soundfont').innerText = file.name;
            const data = new Uint8Array(e.target.result);
            wml.setupByBuffer(data);
          };
        };

        // local file
        document.addEventListener(
          'DOMContentLoaded',
          event => {
            console.log('Document loaded');
            // File selector

            fileInput.addEventListener('change', event => {
              event.preventDefault();
              handleSoundFont(fileInput.files[0]);
              fileInput.value = '';
            });

            placeholder.addEventListener(
              'dragover',
              e => {
                placeholder.className = 'alert-danger';
                e.preventDefault();
              },
              true
            );

            placeholder.addEventListener(
              'drop',
              e => {
                placeholder.className = '';
                const dt = e.dataTransfer;
                const files = dt.files;
                e.stopPropagation();
                e.preventDefault();
                handleSoundFont(files[0]);
              },
              true
            );

            placeholder.addEventListener(
              'dragleave',
              e => {
                placeholder.className = '';
              },
              true
            );
          },
          false
        );
      };
    </script>
  </body>
</html>
