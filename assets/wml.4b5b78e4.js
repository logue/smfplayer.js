import{q as Q}from"./index.9dd16a71.js";/**
 * @logue/sf2synth
 *
 * @description SoundFont2 Synthesizer
 * @author iyama, Logue
 * @license MIT
 * @version 0.4.10
 * @see {@link https://github.com/logue/sf2synth.js}
 */class X{constructor(e,t,n){this.ctx=e,this.destination=t,this.instrument=n,this.channel=n.channel,this.key=n.key,this.velocity=n.velocity,this.buffer=n.sample,this.playbackRate=n.basePlaybackRate,this.loopStart=n.loopStart,this.loopEnd=n.loopEnd,this.sampleRate=n.sampleRate,this.volume=n.volume,this.panpot=n.panpot,this.pitchBend=n.pitchBend,this.pitchBendSensitivity=n.pitchBendSensitivity,this.modEnvToPitch=n.modEnvToPitch,this.expression=n.expression,this.modulation=n.modulation,this.cutOffFrequency=n.cutOffFrequency,this.hermonicContent=n.hermonicContent,this.reverb=n.reverb,this.startTime=e.currentTime,this.computedPlaybackRate=this.playbackRate|0,this.noteOffState=!1,this.audioBuffer=null,this.bufferSource=e.createBufferSource(),this.panner=e.createPanner(),this.outputGainNode=e.createGain(),this.expressionGainNode=e.createGain(),this.filter=e.createBiquadFilter(),this.modulator=e.createBiquadFilter()}noteOn(){const e=this.ctx,t=this.instrument,n=this.ctx.currentTime||0,s=n+t.volDelay,i=n+t.modDelay,o=s+t.volAttack,r=s+t.modAttack,h=o+t.volHold,l=r+t.modHold,u=h+t.volDecay,d=l+t.modDecay,c=t.loopStart/this.sampleRate,p=t.loopEnd/this.sampleRate,f=t.start/this.sampleRate,m=t.pan!==0?t.pan:this.panpot,y=this.buffer.subarray(0,this.buffer.length+t.end),v=this.audioBuffer=e.createBuffer(1,y.length,this.sampleRate);v.getChannelData(0).set(y);const g=this.bufferSource;g.buffer=v,g.loop=t.sampleModes||0,g.loopStart=c,g.loopEnd=p,this.updatePitchBend(this.pitchBend);const x=this.outputGainNode;this.expressionGainNode.gain.value=this.expression/127;const b=this.panner;b.panningModel="equalpower",b.distanceModel="inverse",b.setPosition(Math.sin(m*Math.PI/2),0,Math.cos(m*Math.PI/2));let M=this.volume*(this.velocity/127)*(1-t.initialAttenuation/1e3);M<0&&(M=0);const E=x.gain;E.setValueAtTime(0,n),E.setValueAtTime(0,s),E.setTargetAtTime(M,s,t.volAttack),E.setValueAtTime(M,h),E.linearRampToValueAtTime(M*(1-t.volSustain),u);const k=t.initialFilterFc,R=t.initialFilterFc+t.modEnvToFilterFc,$=k+(R-k)*(1-t.modSustain),w=this.modulator;w.Q.setValueAtTime(10**(t.initialFilterQ/200),n),w.frequency.value=k,w.type="lowpass",w.frequency.setTargetAtTime(k/127,this.ctx.currentTime,.5),w.frequency.setValueAtTime(k,n),w.frequency.setValueAtTime(k,i),w.frequency.setTargetAtTime(R,i,parseFloat(t.modAttack)),w.frequency.setValueAtTime(R,l),w.frequency.exponentialRampToValueAtTime($,d),g.connect(w),w.connect(b),b.connect(this.expressionGainNode),t.mute||this.connect(),this.expressionGainNode.connect(x),g.start(0,f)}amountToFreq(e){return 2**((e-6900)/1200)*440}noteOff(){this.noteOffState=!0}isNoteOff(){return this.noteOffState}release(){const e=this.instrument,t=this.bufferSource,n=this.outputGainNode,s=this.ctx.currentTime,i=e.releaseTime-64,o=e.volRelease*n.gain.value,r=s+o*(1+i/(i<0?64:63)),h=this.modulator,l=e.initialFilterFc,u=e.initialFilterFc+e.modEnvToFilterFc,d=s+e.modRelease*(l===u?1:(h.frequency.value-l)/(u-l));if(this.audioBuffer)switch(e.sampleModes){case 0:t.loop=!1;break;case 1:n.gain.cancelScheduledValues(0),n.gain.setValueAtTime(n.gain.value,s),n.gain.linearRampToValueAtTime(0,r),h.frequency.cancelScheduledValues(0),h.frequency.setValueAtTime(h.frequency.value,s),h.frequency.exponentialRampToValueAtTime(l,d),t.playbackRate.cancelScheduledValues(0),t.playbackRate.setValueAtTime(t.playbackRate.value,s),t.playbackRate.exponentialRampToValueAtTime(this.computedPlaybackRate,d),t.stop(r);break;case 2:throw Error("[SynthesizerNote] Detect unused sampleModes");case 3:n.gain.cancelScheduledValues(0),n.gain.setValueAtTime(n.gain.value,s),n.gain.linearRampToValueAtTime(0,r),h.frequency.cancelScheduledValues(0),h.frequency.setValueAtTime(h.frequency.value,s),h.frequency.exponentialRampToValueAtTime(l,d),t.playbackRate.cancelScheduledValues(0),t.playbackRate.setValueAtTime(t.playbackRate.value,s),t.playbackRate.exponentialRampToValueAtTime(this.computedPlaybackRate,d),t.loop=!1,t.buffer=null;break;default:throw Error(`[SynthesizerNote] ${e.sampleModes} is undefined sampleModes.`)}}connect(){this.reverb.connect(this.outputGainNode).connect(this.destination)}disconnect(){this.outputGainNode.disconnect(0)}schedulePlaybackRate(){const e=this.bufferSource.playbackRate,t=this.computedPlaybackRate,n=this.startTime,s=this.instrument,i=n+s.modAttack,o=i+s.modDecay,r=t*1.0594630943592953**(this.modEnvToPitch*this.instrument.scaleTuning);e.cancelScheduledValues(0),e.setValueAtTime(t,n),e.linearRampToValueAtTime(r,i),e.linearRampToValueAtTime(t+(r-t)*(1-s.modSustain),o)}updateExpression(e){this.expressionGainNode.gain.value=(this.expression=e)/127}updatePitchBend(e){this.computedPlaybackRate=this.playbackRate*1.0594630943592953**(e/(e<0?8192:8191)*this.pitchBendSensitivity*this.instrument.scaleTuning),this.schedulePlaybackRate()}}/**
 * @logue/reverb
 *
 * @description JavaScript Reverb effect class
 * @author Logue <logue@hotmail.co.jp>
 * @copyright 2019-2022 By Masashi Yoshikawa All rights reserved.
 * @license MIT
 * @version 1.1.0
 * @see {@link https://github.com/logue/Reverb.js}
 */const S={BLUE:"blue",GREEN:"green",PINK:"pink",RED:"red",VIOLET:"violet",WHITE:"white",BROWN:"red"},V=1/2**32;class K{float(e=1){return this.int()*V*e}norm(e=1){return(this.int()*V-.5)*2*e}minmax(e,t){return this.float()*(t-e)+e}minmaxInt(e,t){return e|=0,t|=0,e+(this.float()*(t-e)|0)}}const G=Math.random;class Y extends K{int(){return G()*4294967296>>>0}float(e=1){return G()*e}norm(e=1){return(G()-.5)*2*e}}const C=new Y,J={noise:S.WHITE,scale:2,peaks:2,randomAlgorithm:C,decay:2,delay:0,reverse:!1,time:2,filterType:"lowpass",filterFreq:2200,filterQ:1,mix:.5,once:!1},_={version:"1.1.0",date:"2022-10-04T02:13:31.946Z"},L=(a,e,t)=>{const n=new Array(a);for(let s=0;s<a;s++)n[s]=t.norm(e);return n},q=a=>a.reduce((e,t)=>e+t,0);function*z(a,e){const t=[a[Symbol.iterator](),e[Symbol.iterator]()];for(let n=0;;n^=1){const s=t[n].next();if(s.done)return;yield s.value}}function*O(a=2,e=1,t=C){const n=L(a,e,t);n.forEach((o,r)=>n[r]=r&1?o:-o);const s=1/a;let i=q(n);for(let o=0,r=-1;;++o>=a&&(o=0))i-=n[o],i+=n[o]=r*t.norm(e),r^=4294967294,yield r*i*s}const ee=(a=2,e=1,t=C)=>z(O(a,e,t),O(a,e,t)),te=a=>{let e=32;return a&=-a,a&&e--,a&65535&&(e-=16),a&16711935&&(e-=8),a&252645135&&(e-=4),a&858993459&&(e-=2),a&1431655765&&(e-=1),e};function*ne(a=8,e=1,t=C){const n=L(a,e,t),s=1/a;let i=q(n);for(let o=0;;o=o+1>>>0){const r=te(o)%a;i-=n[r],i+=n[r]=t.norm(e),yield i*s}}function*B(a=2,e=1,t=C){const n=L(a,e,t),s=1/a;let i=q(n);for(let o=0;;++o>=a&&(o=0))i-=n[o],i+=n[o]=t.norm(e),yield i*s}const se=(a=2,e=1,t=C)=>z(B(a,e,t),B(a,e,t));function*F(a=1,e=C){for(;;)yield e.norm(a)}const ie=(a,e)=>a!=null&&typeof a[e]=="function",oe=a=>ie(a,"xform")?a.xform():a,re=a=>a!=null&&typeof a[Symbol.iterator]=="function";class T{constructor(e){this.value=e}deref(){return this.value}}const ae=a=>new T(a),he=a=>a instanceof T,le=a=>a instanceof T?a:new T(a),D=a=>a instanceof T?a.deref():a,ce=(a,e)=>[a,t=>t,e];function de(a){return a?[...a]:ce(()=>[],(e,t)=>(e.push(t),e))}function*ue(a,e){const t=oe(a)(de()),n=t[1],s=t[2];for(let i of e){const o=s([],i);if(he(o)){yield*D(n(o.deref()));return}o.length&&(yield*o)}yield*D(n([]))}const pe=(a,e)=>[a[0],a[1],e];function j(a,e){return re(e)?ue(j(a),e):t=>{const n=t[2];let s=a;return pe(t,(i,o)=>--s>0?n(i,o):s===0?le(n(i,o)):ae(i))}}class I{constructor(e,t){this.noise=F,this.ctx=e,this.options={...J,...t},this.wetGainNode=this.ctx.createGain(),this.dryGainNode=this.ctx.createGain(),this.filterNode=this.ctx.createBiquadFilter(),this.convolverNode=this.ctx.createConvolver(),this.outputNode=this.ctx.createGain(),this.isConnected=!1,this.setNoise(this.options.noise),this.buildImpulse(),this.mix(this.options.mix)}connect(e){return this.isConnected&&this.options.once?(this.isConnected=!1,this.outputNode):(this.convolverNode.connect(this.filterNode),this.filterNode.connect(this.wetGainNode),e.connect(this.convolverNode),e.connect(this.dryGainNode).connect(this.outputNode),e.connect(this.wetGainNode).connect(this.outputNode),this.isConnected=!0,this.outputNode)}disconnect(e){return this.isConnected&&(this.convolverNode.disconnect(this.filterNode),this.filterNode.disconnect(this.wetGainNode)),this.isConnected=!1,e}mix(e){if(!this.inRange(e,0,1))throw new RangeError("[Reverb.js] Dry/Wet ratio must be between 0 to 1.");this.options.mix=e,this.dryGainNode.gain.value=1-this.options.mix,this.wetGainNode.gain.value=this.options.mix}time(e){if(!this.inRange(e,1,50))throw new RangeError("[Reverb.js] Time length of inpulse response must be less than 50sec.");this.options.time=e,this.buildImpulse()}decay(e){if(!this.inRange(e,0,100))throw new RangeError("[Reverb.js] Inpulse Response decay level must be less than 100.");this.options.decay=e,this.buildImpulse()}delay(e){if(!this.inRange(e,0,100))throw new RangeError("[Reverb.js] Inpulse Response delay time must be less than 100.");this.options.delay=e,this.buildImpulse()}reverse(e){this.options.reverse=e,this.buildImpulse()}filterType(e){this.filterNode.type=this.options.filterType=e}filterFreq(e){if(!this.inRange(e,20,2e4))throw new RangeError("[Reverb.js] Filter frequrncy must be between 20 and 20000.");this.options.filterFreq=e,this.filterNode.frequency.value=this.options.filterFreq}filterQ(e){if(!this.inRange(e,0,10))throw new RangeError("[Reverb.js] Filter quality value must be between 0 and 10.");this.options.filterQ=e,this.filterNode.Q.value=this.options.filterQ}peaks(e){this.options.peaks=e,this.buildImpulse()}scale(e){this.options.scale=e,this.buildImpulse()}randomAlgorithm(e){this.options.randomAlgorithm=e,this.buildImpulse()}setNoise(e){switch(this.options.noise=e,e){case S.BLUE:this.noise=O;break;case S.GREEN:this.noise=ee;break;case S.PINK:this.noise=ne;break;case S.RED:case S.BROWN:this.noise=B;break;case S.VIOLET:this.noise=se;break;default:this.noise=F;break}this.buildImpulse()}setRandomAlgorythm(e){this.options.randomAlgorithm=e,this.buildImpulse()}inRange(e,t,n){return(e-t)*(e-n)<=0}buildImpulse(){const e=this.ctx.sampleRate,t=Math.max(e*this.options.time,1),n=e*this.options.delay,s=this.ctx.createBuffer(2,t,e),i=new Float32Array(t),o=new Float32Array(t),r=this.getNoise(t),h=this.getNoise(t);for(let l=0;l<t;l++){let u=0;l<n?(i[l]=0,o[l]=0,u=this.options.reverse?t-(l-n):l-n):u=this.options.reverse?t-l:l,i[l]=r[l]*(1-u/t)**this.options.decay,o[l]=h[l]*(1-u/t)**this.options.decay}s.getChannelData(0).set(i),s.getChannelData(1).set(o),this.convolverNode.buffer=s}getNoise(e){return[...j(e,this.options.noise===S.WHITE?this.noise(this.options.peaks,this.options.randomAlgorithm):this.noise(this.options.peaks,this.options.scale,this.options.randomAlgorithm))]}}I.version=_.version;I.build=_.date;window.Reverb||(window.Reverb=I);class A{constructor(e,t={}){this.input=e,this.ip=t.index||0,this.length=t.length||e.length-this.ip,this.chunkList=[],this.offset=this.ip,this.padding=t.padding!==void 0?t.padding:!0,this.bigEndian=t.bigEndian!==void 0?t.bigEndian:!1}parse(){const e=this.length+this.offset;for(this.chunkList=[];this.ip<e;)this.parseChunk()}parseChunk(){const e=this.input;let t=this.ip,n;this.chunkList.push(new me(String.fromCharCode(e[t++],e[t++],e[t++],e[t++]),n=this.bigEndian?(e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++])>>>0:(e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24)>>>0,t)),t+=n,this.padding&&(t-this.offset&1)===1&&t++,this.ip=t}getChunk(e){const t=this.chunkList[e];return t===void 0?null:t}getNumberOfChunks(){return this.chunkList.length}}class me{constructor(e,t,n){this.type=e,this.size=t,this.offset=n}}class U{constructor(e,t={}){this.input=e,this.parserOption=t.parserOption||{},this.sampleRate=t.sampleRate||22050,this.presetHeader=[],this.presetZone=[],this.presetZoneModulator=[],this.presetZoneGenerator=[],this.instrument=[],this.instrumentZone=[],this.instrumentZoneModulator=[],this.instrumentZoneGenerator=[],this.sampleHeader=[],this.GeneratorEnumeratorTable=Object.keys(this.getGeneratorTable())}getGeneratorTable(){return Object.freeze({startAddrsOffset:0,endAddrsOffset:0,startloopAddrsOffset:0,endloopAddrsOffset:0,startAddrsCoarseOffset:0,modLfoToPitch:0,vibLfoToPitch:0,modEnvToPitch:0,initialFilterFc:13500,initialFilterQ:0,modLfoToFilterFc:0,modEnvToFilterFc:0,endAddrsCoarseOffset:0,modLfoToVolume:0,unused1:void 0,chorusEffectsSend:0,reverbEffectsSend:0,pan:0,unused2:void 0,unused3:void 0,unused4:void 0,delayModLFO:-12e3,freqModLFO:0,delayVibLFO:-12e3,freqVibLFO:0,delayModEnv:-12e3,attackModEnv:-12e3,holdModEnv:-12e3,decayModEnv:-12e3,sustainModEnv:0,releaseModEnv:-12e3,keynumToModEnvHold:0,keynumToModEnvDecay:0,delayVolEnv:-12e3,attackVolEnv:-12e3,holdVolEnv:-12e3,decayVolEnv:-12e3,sustainVolEnv:0,releaseVolEnv:-12e3,keynumToVolEnvHold:0,keynumToVolEnvDecay:0,instrument:null,reserved1:void 0,keyRange:null,velRange:null,startloopAddrsCoarseOffset:0,keynum:null,velocity:null,initialAttenuation:0,reserved2:void 0,endloopAddrsCoarseOffset:0,coarseTune:0,fineTune:0,sampleID:null,sampleModes:0,reserved3:void 0,scaleTuning:100,exclusiveClass:null,overridingRootKey:null,unuded5:void 0,endOper:void 0})}parse(){const e=new A(this.input,this.parserOption);if(e.parse(),e.chunkList.length!==1)throw new Error("wrong chunk length");const t=e.getChunk(0);if(t===null)throw new Error("chunk not found");this.parseRiffChunk(t),this.input=null}parseRiffChunk(e){const t=this.input;let n=e.offset;if(e.type!=="RIFF")throw new Error("invalid chunk type:"+e.type);const s=String.fromCharCode(t[n++],t[n++],t[n++],t[n++]);if(s!=="sfbk")throw new Error("invalid signature:"+s);const i=new A(t,{index:n,length:e.size-4});if(i.parse(),i.getNumberOfChunks()!==3)throw new Error("invalid sfbk structure");this.parseInfoList(i.getChunk(0)),this.parseSdtaList(i.getChunk(1)),this.parsePdtaList(i.getChunk(2))}parseInfoList(e){const t=this.input;let n=e.offset;if(e.type!=="LIST")throw new Error("invalid chunk type:"+e.type);const s=String.fromCharCode(t[n++],t[n++],t[n++],t[n++]);if(s!=="INFO")throw new Error("invalid signature:"+s);new A(t,{index:n,length:e.size-4}).parse()}parseSdtaList(e){const t=this.input;let n=e.offset;if(e.type!=="LIST")throw new Error("invalid chunk type:"+e.type);const s=String.fromCharCode(t[n++],t[n++],t[n++],t[n++]);if(s!=="sdta")throw new Error("invalid signature:"+s);const i=new A(t,{index:n,length:e.size-4});if(i.parse(),i.chunkList.length!==1)throw new Error("TODO");this.samplingData=i.getChunk(0)}parsePdtaList(e){const t=this.input;let n=e.offset;if(e.type!=="LIST")throw new Error("invalid chunk type:"+e.type);const s=String.fromCharCode(t[n++],t[n++],t[n++],t[n++]);if(s!=="pdta")throw new Error("invalid signature:"+s);const i=new A(t,{index:n,length:e.size-4});if(i.parse(),i.getNumberOfChunks()!==9)throw new Error("invalid pdta chunk");this.parsePhdr(i.getChunk(0)),this.parsePbag(i.getChunk(1)),this.parsePmod(i.getChunk(2)),this.parsePgen(i.getChunk(3)),this.parseInst(i.getChunk(4)),this.parseIbag(i.getChunk(5)),this.parseImod(i.getChunk(6)),this.parseIgen(i.getChunk(7)),this.parseShdr(i.getChunk(8))}parsePhdr(e){const t=this.input;let n=e.offset;const s=this.presetHeader=[],i=e.offset+e.size;if(e.type!=="phdr")throw new Error("invalid chunk type:"+e.type);for(;n<i;)s.push({presetName:String.fromCharCode.apply(null,t.subarray(n,n+=20)),preset:t[n++]|t[n++]<<8,bank:t[n++]|t[n++]<<8,presetBagIndex:t[n++]|t[n++]<<8,library:(t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0,genre:(t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0,morphology:(t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0})}parsePbag(e){const t=this.input;let n=e.offset;const s=this.presetZone=[],i=e.offset+e.size;if(e.type!=="pbag")throw new Error("invalid chunk type:"+e.type);for(;n<i;)s.push({presetGeneratorIndex:t[n++]|t[n++]<<8,presetModulatorIndex:t[n++]|t[n++]<<8})}parsePmod(e){if(e.type!=="pmod")throw new Error("invalid chunk type:"+e.type);this.presetZoneModulator=this.parseModulator(e)}parsePgen(e){if(e.type!=="pgen")throw new Error("invalid chunk type:"+e.type);this.presetZoneGenerator=this.parseGenerator(e)}parseInst(e){const t=this.input;let n=e.offset;const s=this.instrument=[],i=e.offset+e.size;if(e.type!=="inst")throw new Error("invalid chunk type:"+e.type);for(;n<i;)s.push({instrumentName:String.fromCharCode.apply(null,t.subarray(n,n+=20)),instrumentBagIndex:t[n++]|t[n++]<<8})}parseIbag(e){const t=this.input;let n=e.offset;const s=this.instrumentZone=[],i=e.offset+e.size;if(e.type!=="ibag")throw new Error("invalid chunk type:"+e.type);for(;n<i;)s.push({instrumentGeneratorIndex:t[n++]|t[n++]<<8,instrumentModulatorIndex:t[n++]|t[n++]<<8})}parseImod(e){if(e.type!=="imod")throw new Error("invalid chunk type:"+e.type);this.instrumentZoneModulator=this.parseModulator(e)}parseIgen(e){if(e.type!=="igen")throw new Error("invalid chunk type:"+e.type);this.instrumentZoneGenerator=this.parseGenerator(e)}parseShdr(e){const t=this.input;let n=e.offset;const s=this.sample=[],i=this.sampleHeader=[],o=e.offset+e.size;let r,h,l,u,d,c,p,f,m,y;if(e.type!=="shdr")throw new Error("invalid chunk type:"+e.type);for(;n<o;){r=String.fromCharCode.apply(null,t.subarray(n,n+=20)),h=(t[n++]<<0|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0,l=(t[n++]<<0|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0,u=(t[n++]<<0|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0,d=(t[n++]<<0|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0,c=(t[n++]<<0|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0,p=t[n++],f=t[n++]<<24>>24,m=t[n++]|t[n++]<<8,y=t[n++]|t[n++]<<8;let v=new Int16Array(new Uint8Array(t.subarray(this.samplingData.offset+h*2,this.samplingData.offset+l*2)).buffer);if(u-=h,d-=h,c>0){const g=this.adjustSampleData(v,c);v=g.sample,c*=g.multiply,u*=g.multiply,d*=g.multiply}s.push(v),i.push({sampleName:r,start:h,end:l,startLoop:u,endLoop:d,sampleRate:c,originalPitch:p,pitchCorrection:f,sampleLink:m,sampleType:y})}}adjustSampleData(e,t){let n,s,i,o,r=1;for(;t<this.sampleRate;){for(n=new Int16Array(e.length*2),s=o=0,i=e.length;s<i;++s)n[o++]=e[s],n[o++]=e[s];e=n,r*=2,t*=2}return{sample:e,multiply:r}}parseModulator(e){const t=this.input;let n=e.offset;const s=e.offset+e.size;let i,o;const r=[];for(;n<s;){if(n+=2,i=t[n++]|t[n++]<<8,o=this.GeneratorEnumeratorTable[i],o===void 0)r.push({type:o,value:{code:i,amount:t[n]|t[n+1]<<8<<16>>16,lo:t[n++],hi:t[n++]}});else switch(o){case"keyRange":case"velRange":case"keynum":case"velocity":r.push({type:o,value:{amount:null,lo:t[n++],hi:t[n++]}});break;default:r.push({type:o,value:{amount:t[n++]|t[n++]<<8<<16>>16}});break}n+=2,n+=2}return r}parseGenerator(e){const t=this.input;let n=e.offset;const s=e.offset+e.size;let i,o;const r=[];for(;n<s;){if(i=t[n++]|t[n++]<<8,o=this.GeneratorEnumeratorTable[i],o===void 0){r.push({type:o,value:{code:i,amount:t[n]|t[n+1]<<8<<16>>16,lo:t[n++],hi:t[n++]}});continue}switch(o){case"keynum":case"keyRange":case"velRange":case"velocity":r.push({type:o,value:{amount:null,lo:t[n++],hi:t[n++]}});break;default:r.push({type:o,value:{amount:t[n++]|t[n++]<<8<<16>>16}});break}}return r}createInstrument(){const e=this.instrument,t=this.instrumentZone,n=[];let s,i,o,r,h,l,u,d,c;for(l=0,u=e.length;l<u;++l){for(s=e[l].instrumentBagIndex,i=e[l+1]?e[l+1].instrumentBagIndex:t.length,o=[],d=s,c=i;d<c;++d)r=this.createInstrumentGenerator_(t,d),h=this.createInstrumentModulator_(t,d),o.push({generator:r.generator,generatorSequence:r.generatorInfo,modulator:h.modulator,modulatorSequence:h.modulatorInfo});n.push({name:e[l].instrumentName,info:o})}return n}createPreset(){const e=this.presetHeader,t=this.presetZone,n=[];let s,i,o,r,h,l,u,d,c,p;for(u=0,d=e.length;u<d;++u){for(s=e[u].presetBagIndex,i=e[u+1]?e[u+1].presetBagIndex:t.length,o=[],c=s,p=i;c<p;++c)h=this.createPresetGenerator_(t,c),l=this.createPresetModulator_(t,c),o.push({generator:h.generator,generatorSequence:h.generatorInfo,modulator:l.modulator,modulatorSequence:l.modulatorInfo}),r=h.generator.instrument!==void 0?h.generator.instrument.amount:l.modulator.instrument!==void 0?l.modulator.instrument.amount:null;n.push({name:e[u].presetName,info:o,header:e[u],instrument:r})}return n}createInstrumentGenerator_(e,t){const n=this.createBagModGen_(e,e[t].instrumentGeneratorIndex,e[t+1]?e[t+1].instrumentGeneratorIndex:this.instrumentZoneGenerator.length,this.instrumentZoneGenerator);return{generator:n.modgen,generatorInfo:n.modgenInfo}}createInstrumentModulator_(e,t){const n=this.createBagModGen_(e,e[t].presetModulatorIndex,e[t+1]?e[t+1].instrumentModulatorIndex:this.instrumentZoneModulator.length,this.instrumentZoneModulator);return{modulator:n.modgen,modulatorInfo:n.modgenInfo}}createPresetGenerator_(e,t){const n=this.createBagModGen_(e,e[t].presetGeneratorIndex,e[t+1]?e[t+1].presetGeneratorIndex:this.presetZoneGenerator.length,this.presetZoneGenerator);return{generator:n.modgen,generatorInfo:n.modgenInfo}}createPresetModulator_(e,t){const n=this.createBagModGen_(e,e[t].presetModulatorIndex,e[t+1]?e[t+1].presetModulatorIndex:this.presetZoneModulator.length,this.presetZoneModulator);return{modulator:n.modgen,modulatorInfo:n.modgenInfo}}createBagModGen_(e,t,n,s){const i=[],o={unknown:[],keyRange:{amount:null,hi:127,lo:0}};let r,h,l;for(h=t,l=n;h<l;++h)r=s[h],i.push(r),r.type==="unknown"?o.unknown.push(r.value):o[r.type]=r.value;return{modgen:o,modgenInfo:i}}}class fe{constructor(e){let t,n;for(this.input=e,this.parser={},this.bank=0,this.bankSet={},this.bufferSize=2048,this.ctx=this.getAudioContext(),this.gainMaster=this.ctx.createGain(),this.bufSrc=this.ctx.createBufferSource(),this.channelInstrument=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.channelBank=[0,0,0,0,0,0,0,0,0,127,0,0,0,0,0,0],this.channelVolume=[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],this.channelPanpot=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelPitchBend=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.channelPitchBendSensitivity=[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],this.channelExpression=[127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127],this.channelAttack=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelDecay=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelSustin=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelRelease=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelHold=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.channelHarmonicContent=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelCutOffFrequency=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.mode="GM2",this.programSet=[],this.channelMute=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.currentNoteOn=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],this.baseVolume=1/65535,this.masterVolume=16384,this.percussionPart=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1],this.percussionVolume=new Array(128),t=0,n=this.percussionVolume.length;t<n;++t)this.percussionVolume[t]=127;for(this.programSet={},this.reverb=[],this.modulation=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.filter=[],t=0;t<16;++t)this.reverb[t]=new I(this.ctx,{noise:"violet",scale:2,peaks:16,filterType:"allpass"}),this.filter[t]=this.ctx.createBiquadFilter();this.items=[],this.intersection=new IntersectionObserver(s=>s.forEach(i=>i.target.dataset.isIntersecting=i.isIntersecting),{}),this.timer=null}getAudioContext(){const e=new AudioContext,t=()=>{document.removeEventListener("touchstart",t);const n=e.createBufferSource();n.start(),n.stop()};return document.addEventListener("touchstart",t),e}init(e="GM"){this.gainMaster.disconnect(),this.refreshInstruments(this.input),this.mode=e;for(let t=0;t<16;++t)this.programChange(t,0),this.volumeChange(t,100),this.panpotChange(t,64),this.pitchBend(t,0,64),this.pitchBendSensitivity(t,2),this.hold(t,0),this.expression(t,127),this.bankSelectMsb(t,t===9?127:0),this.attackTime(t,64),this.decayTime(t,64),this.sustinTime(t,64),this.releaseTime(t,64),this.harmonicContent(t,64),this.cutOffFrequency(t,64),this.reverbDepth(t,40),this.modulationDepth(t,0),this.updateBankSelect(t),this.updateProgramSelect(t);this.setPercussionPart(9,!0);for(let t=0;t<128;++t)this.percussionVolume[t]=127;this.gainMaster.connect(this.ctx.destination),this.element&&(this.element.querySelector(".header .keys div").innerText=e+" Mode"),this.element.dataset.mode=e}close(){this.ctx.close()}refreshInstruments(e){this.input=e,this.parser=new U(e,{sampleRate:this.ctx.sampleRate}),this.bankSet=this.createAllInstruments()}createAllInstruments(){const e=this.parser;e.parse();const t=e.createPreset(),n=e.createInstrument(),s=[];let i,o,r,h,l,u,d,c,p,f;const m=[];for(u=0,d=t.length;u<d;++u)if(r=t[u],l=r.header.preset,o=r.header.bank,f=r.name.replace(/\0*$/,""),typeof r.instrument=="number"&&(h=n[r.instrument],h.name.replace(/\0*$/,"")!=="EOI")){for(s[o]===void 0&&(s[o]=[]),i=s[o],i[l]={},i[l].name=f,c=0,p=h.info.length;c<p;++c)this.createNoteInfo(e,h.info[c],i[l]);m[o]||(m[o]={}),m[o][l]=f}return this.programSet=m,s}createNoteInfo(e,t,n){const s=t.generator;if(!s.keyRange||!s.sampleID)return;const i=this.getModGenAmount(s,"delayVolEnv"),o=this.getModGenAmount(s,"attackVolEnv"),r=this.getModGenAmount(s,"holdVolEnv"),h=this.getModGenAmount(s,"decayVolEnv"),l=this.getModGenAmount(s,"sustainVolEnv"),u=this.getModGenAmount(s,"releaseVolEnv"),d=this.getModGenAmount(s,"delayModEnv"),c=this.getModGenAmount(s,"attackModEnv"),p=this.getModGenAmount(s,"holdModEnv"),f=this.getModGenAmount(s,"decayModEnv"),m=this.getModGenAmount(s,"sustainModEnv"),y=this.getModGenAmount(s,"releaseModEnv"),v=this.getModGenAmount(s,"scaleTuning")/100,g=this.getModGenAmount(s,"coarseTune")+this.getModGenAmount(s,"fineTune")/100,x=this.getModGenAmount(s,"sampleModes");for(let b=s.keyRange.lo,M=s.keyRange.hi;b<=M;++b){if(n[b])continue;const E=this.getModGenAmount(s,"sampleID"),k=e.sampleHeader[E];n[b]={sample:e.sample[E],sampleRate:k.sampleRate,sampleModes:x,basePlaybackRate:1.0594630943592953**((b-this.getModGenAmount(s,"overridingRootKey",k.originalPitch)+g+k.pitchCorrection/100)*v),modEnvToPitch:this.getModGenAmount(s,"modEnvToPitch")/100,scaleTuning:v,start:this.getModGenAmount(s,"startAddrsCoarseOffset")*32768+this.getModGenAmount(s,"startAddrsOffset"),end:this.getModGenAmount(s,"endAddrsCoarseOffset")*32768+this.getModGenAmount(s,"endAddrsOffset"),loopStart:k.startLoop+this.getModGenAmount(s,"startloopAddrsCoarseOffset")*32768+this.getModGenAmount(s,"startloopAddrsOffset"),loopEnd:k.endLoop+this.getModGenAmount(s,"endloopAddrsCoarseOffset")*32768+this.getModGenAmount(s,"endloopAddrsOffset"),volDelay:2**(i/1200),volAttack:2**(o/1200),volHold:2**(r/1200)*2**((60-b)*this.getModGenAmount(s,"keynumToVolEnvHold")/1200),volDecay:2**(h/1200)*2**((60-b)*this.getModGenAmount(s,"keynumToVolEnvDecay")/1200),volSustain:l/1e3,volRelease:2**(u/1200),modDelay:2**(d/1200),modAttack:2**(c/1200),modHold:2**(p/1200)*2**((60-b)*this.getModGenAmount(s,"keynumToModEnvHold")/1200),modDecay:2**(f/1200)*2**((60-b)*this.getModGenAmount(s,"keynumToModEnvDecay")/1200),modSustain:m/1e3,modRelease:2**(y/1200),initialFilterFc:8.176*Math.pow(2,this.getModGenAmount(s,"initialFilterFc")/1200),modEnvToFilterFc:this.getModGenAmount(s,"modEnvToFilterFc")/100,initialFilterQ:this.getModGenAmount(s,"initialFilterQ")/10,reverbEffectSend:this.getModGenAmount(s,"reverbEffectSend")/10,initialAttenuation:this.getModGenAmount(s,"initialAttenuation")/10,freqVibLFO:8.176*Math.pow(2,this.getModGenAmount(s,"freqVibLFO")/1200),pan:this.getModGenAmount(s,"pan")/1200}}}getModGenAmount(e,t){return e[t]?e[t].amount:this.parser.getGeneratorTable()[t]}start(){this.connect(),this.bufSrc.start(0),this.setMasterVolume(16383)}setMasterVolume(e){this.masterVolume=e,this.gainMaster.gain.value=this.baseVolume*(e/16384)}connect(){this.bufSrc.connect(this.gainMaster)}disconnect(){this.bufSrc.disconnect(this.gainMaster),this.bufSrc.buffer=null}drawSynth(){const e=window.document,t=this.element=e.createElement("div");t.className="synthesizer";const n=e.createElement("div");n.className="instrument",this.items=["mute","bank","program","volume","expression","panpot","pitchBend","pitchBendSensitivity","reverbDepth","keys"];const s="ontouchstart"in window?"touchstart":"mousedown",i="ontouchend"in window?"touchend":"mouseup";for(let h=0;h<16;h++){const l=e.createElement("div");l.className="channel",l.addEventListener(s,()=>{this.hold(h,0)});for(const u in this.items){if(!{}.hasOwnProperty.call(this.items,u))continue;const d=e.createElement("div");switch(d.className=this.items[u],this.items[u]){case"mute":{const c=e.createElement("div");c.className="form-check form-check-inline";const p=e.createElement("input");p.setAttribute("type","checkbox"),p.className="form-check-input",p.id="mute"+h+"ch",p.value=h,p.addEventListener("input",m=>{this.mute(h,m.target.checked)},!1),c.appendChild(p);const f=e.createElement("label");f.className="form-check-label",f.textContent=h+1,f.setAttribute("for","mute"+h+"ch"),c.appendChild(f),d.appendChild(c);break}case"bank":{const c=e.createElement("select");c.className="form-select form-select-sm",c.addEventListener("change",((p,f)=>m=>{const y=l.querySelector(".program select").value;p.bankChange(f,m.target.value),p.programChange(f,y)})(this,h),!1),d.appendChild(c);break}case"program":{const c=e.createElement("select");c.className="form-select form-select-sm",c.addEventListener("change",((p,f)=>m=>{p.programChange(f,m.target.value)})(this,h),!1),d.appendChild(c);break}case"volume":{const c=document.createElement("var");c.innerText=100,d.appendChild(c);break}case"expression":{const c=document.createElement("var");c.innerText=127,d.appendChild(c);break}case"pitchBendSensitivity":{const c=document.createElement("var");c.innerText=2,d.appendChild(c);break}case"reverbDepth":{const c=document.createElement("var");c.innerText=40,d.appendChild(c);break}case"panpot":{const c=e.createElement("div");c.className="progress";const p=e.createElement("div");p.className="progress-bar",c.appendChild(p),d.appendChild(c);break}case"pitchBend":{const c=e.createElement("div");c.className="progress";const p=e.createElement("div");p.className="progress-bar progress-bar-animated",c.appendChild(p),d.appendChild(c);break}case"keys":{for(let c=0;c<127;c++){const p=e.createElement("div"),f=c%12;p.className="key "+([1,3,6,8,10].includes(f)?"semitone":"tone"),d.appendChild(p),p.addEventListener(s,((m,y,v)=>g=>{g.preventDefault(),m.drag=!0,m.noteOn(y,v,127)})(this,h,c)),p.addEventListener("mouseover",((m,y,v)=>g=>{g.preventDefault(),m.drag&&m.noteOn(y,v,127)})(this,h,c)),p.addEventListener("mouseout",((m,y,v)=>g=>{g.preventDefault(),m.noteOff(y,v,0)})(this,h,c)),p.addEventListener(i,((m,y,v)=>g=>{g.preventDefault(),m.drag=!1,m.noteOff(y,v,0)})(this,h,c))}break}}l.appendChild(d)}n.appendChild(l),this.intersection.observe(l)}const o=["Ch.","Bank","Program","Vol.","Exp.","Panpot","Pitch","","Rev.",""],r=e.createElement("div");r.className="header";for(const h in this.items){if(!{}.hasOwnProperty.call(this.items,h))continue;const l=e.createElement("div");l.className=this.items[h],l.textContent=o[h],this.items[h]==="keys"&&(l.appendChild(document.createElement("code")),l.appendChild(document.createElement("div"))),r.appendChild(l)}return n.prepend(r),t.appendChild(n),new ResizeObserver(h=>{for(const l in this.items)!{}.hasOwnProperty.call(this.items,l)||(t.querySelector(`.header .${this.items[l]}`).style.width=t.querySelector(`.channel .${this.items[l]}`).offsetWidth+"px");t.querySelector(".header .keys").style.display=document.documentElement.clientWidth<=680?"none":"flex"}).observe(t),t}updateSynthElement(e,t,n){if(!this.element)return;const s=this.element.querySelectorAll(".instrument > .channel")[e];if(s.dataset.isIntersecting){const i=s.querySelector(`.key:nth-child(${t+1})`);n===0?(i.classList.contains("note-on")&&i.classList.remove("note-on"),i.style.opacity=1):(i.classList.add("note-on"),i.style.opacity=(n/127).toFixed(2))}}updateBankSelect(e){if(!this.element)return;const t=this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".bank > select");for(;t.firstChild;)t.removeChild(t.firstChild);for(const n in this.programSet){if(!{}.hasOwnProperty.call(this.programSet,n))continue;const s=document.createElement("option");s.value=n,s.textContent=("000"+parseInt(n)).slice(-3),n===this.channelBank[e]&&(s.selected="selected"),t.appendChild(s)}}updateProgramSelect(e){const t=this.element.querySelectorAll(".instrument > .channel")[e],n=this.channelBank[e],s=t.querySelector(".bank > select"),i=t.querySelector(".program > select");for(s.value=this.channelBank[e];i.firstChild;)i.removeChild(i.firstChild);for(const o in this.programSet[n]){if(!{}.hasOwnProperty.call(this.programSet[n],o))continue;const r=document.createElement("option");r.value=o,r.textContent=`${("000"+(parseInt(o)+1)).slice(-3)}:${this.programSet[n][o]}`,o===this.channelInstrument[e]&&(r.selected="selected"),i.appendChild(r)}}noteOn(e,t,n=100){const s=this.channelBank[e],i=typeof this.bankSet[s]=="object"?this.bankSet[s]:this.bankSet[0];let o;if(typeof i[this.channelInstrument[e]]=="object"?o=i[this.channelInstrument[e]]:this.percussionPart[e]?o=this.bankSet[this.mode==="XG"?127:128][0]:o=this.bankSet[0][this.channelInstrument[e]],o[t]===void 0)return;const r=o[t];let h=this.channelPanpot[e]===0?Math.random()*127|0:this.channelPanpot[e]-64;h/=h<0?64:63,r.channel=e,r.key=t,r.velocity=n,r.panpot=h,r.volume=this.channelVolume[e]/127,r.pitchBend=this.channelPitchBend[e]-8192,r.expression=this.channelExpression[e],r.pitchBendSensitivity=Math.round(this.channelPitchBendSensitivity[e]),r.mute=this.channelMute[e],r.releaseTime=this.channelRelease[e],r.cutOffFrequency=this.cutOffFrequency[e],r.harmonicContent=this.harmonicContent[e],r.reverb=this.reverb[e],r.modulation=this.modulation[e],s>125&&(o.volume*=this.percussionVolume[t]/127);const l=new X(this.ctx,this.gainMaster,r);l.noteOn(),this.currentNoteOn[e].push(l),this.updateSynthElement(e,t,n)}noteOff(e,t){let n,s;const i=this.currentNoteOn[e];let o;const r=this.channelHold[e];for(n=0,s=i.length;n<s;++n)o=i[n],o.key===t&&(o.noteOff(),r||(o.release(),i.splice(n,1),--n,--s));this.updateSynthElement(e,t,0)}hold(e,t){const n=this.currentNoteOn[e],s=this.channelHold[e]=t>64;let i,o,r;if(!s)for(o=0,r=n.length;o<r;++o)i=n[o],i.isNoteOff()&&(i.release(),n.splice(o,1),--o,--r);if(this.element){const h=this.element.querySelectorAll(".instrument > .channel")[e];if(!h)return;this.channelHold[e]?h.classList.add("hold"):h.classList.contains("hold")&&h.classList.remove("hold")}}bankSelectMsb(e,t){if(this.mode==="XG")this.channelBank[e]=0,t===64?(this.channelBank[e]=125,this.percussionPart[e]=!0):t===126||t===127?(this.channelBank[e]=t,this.percussionPart[e]=!0):t===128&&(this.channelBank[e]=127,this.percussionPart[e]=!0);else if(this.mode==="GS"||this.mode==="GM2")this.channelBank[e]=e===9?128:t,this.percussionPart[e]=t===128;else return;this.updateBankSelect(e)}bankSelectLsb(e,t){this.mode!=="XG"||this.percussionPart[e]===!0||(this.percussionPart[e]=t>=125,this.channelBank[e]=t,this.updateBankSelect(e))}programChange(e,t){this.channelInstrument[e]=t,this.bankChange(e,this.channelBank[e]),this.element&&(this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".program > select").value=t)}bankChange(e,t){const n=this.mode==="GS"?128:127;e===9&&(t=n),this.bankSet[t]?this.channelBank[e]=t:this.channelBank[e]=this.percussionPart[e]?n:0,this.element&&(this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".bank > select").value=t),this.updateProgramSelect(e)}volumeChange(e,t){this.element&&(this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".volume var").innerText=t),this.channelVolume[e]=t}expression(e,t){let n,s;const i=this.currentNoteOn[e];for(n=0,s=i.length;n<s;++n)i[n].updateExpression(t);this.element&&(this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".expression var").innerText=t),this.channelExpression[e]=t}panpotChange(e,t){if(this.channelPanpot[e]=t,this.element){const n=this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".panpot .progress-bar"),s=t/127*100;if(n.style.width=`${s}%`,n.classList.remove("left","right"),t===64)return;n.classList.add([t<63?"left":"right"])}}pitchBend(e,t,n){const s=t&127|(n&127)<<7;let i,o;const r=this.currentNoteOn[e],h=s-8192;for(i=0,o=r.length;i<o;++i)r[i].updatePitchBend(h);if(this.channelPitchBend[e]=s,this.element){const l=this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".pitchBend .progress-bar");if(l.style.width=`${Math.floor(s/16384*100)}%`,l.classList.remove("high","low"),h===0)return;l.classList.add(h<0?"low":"high")}}pitchBendSensitivity(e,t){this.element&&(this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".pitchBendSensitivity > var").innerText=t),this.channelPitchBendSensitivity[e]=t}attackTime(e,t){this.channelAttack[e]=t}decayTime(e,t){this.channelDecay[e]=t}sustinTime(e,t){this.channelSustin[e]=t}releaseTime(e,t){this.channelRelease[e]=t}harmonicContent(e,t){this.channelHarmonicContent[e]=t}cutOffFrequency(e,t){this.channelCutOffFrequency[e]=t}reverbDepth(e,t){this.reverb[e].mix(t/127),this.element&&(this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".reverbDepth var").innerText=t)}modulationDepth(e,t){if(this.element){const n=this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".pitchBend .progress-bar");t!==0?n.classList.add(["progress-bar-striped"]):n.classList.remove(["progress-bar-striped"])}this.modulation[e]=t}getPitchBendSensitivity(e){return this.channelPitchBendSensitivity[e]}drumInstrumentLevel(e,t){this.percussionVolume[e]=t}allNoteOff(e){const t=this.currentNoteOn[e];for(this.hold(e,0);t.length>0;)this.noteOff(e,t[0].key,0)}allSoundOff(e){const t=this.currentNoteOn[e];let n;for(;t.length>0;)n=t.shift(),this.noteOff(e,n.key,0),n.release(),n.disconnect();this.hold(e,0)}resetAllControl(e){this.allNoteOff(e),this.expression(e,127),this.pitchBend(e,0,64)}mute(e,t){const n=this.currentNoteOn[e];let s,i;if(this.channelMute[e]=t,t)for(s=0,i=n.length;s<i;++s)n[s].disconnect();else for(s=0,i=n.length;s<i;++s)n[s].connect()}setPercussionPart(e,t){this.mode==="GS"||this.mode==="GM2"?this.channelBank[e]=128:this.channelBank[e]=127,this.percussionPart[e]=t}processMidiMessage(e){clearTimeout(this.timer);const t=this.element.querySelector(".header .keys code");t.innerText=e.map(n=>String.fromCharCode(n)).join(""),this.timer=setTimeout(()=>{t.innerText=""},5e4)}}class ge{constructor(e,t,n,s){this.url=e,this.cache=n,this.placeholder=t,this.callback=s,this.alert=document.createElement("div"),this.alert.className="alert alert-warning",this.message=document.createElement("p"),this.message.innerText="Now Loading...",this.progressOuter=document.createElement("div"),this.progressOuter.className="progress",this.progress=document.createElement("div"),this.progress.className="progress-bar",this.progressOuter.appendChild(this.progress),this.alert.appendChild(this.message),this.alert.appendChild(this.progressOuter),this.placeholder.appendChild(this.alert)}onProgress(e,t){const n=Math.floor(e/t*100);this.progress.style.width=n+"%",this.progress.innerText=n+" %",requestAnimationFrame(this.onProgress)}onComplete(e){this.alert.className="alert alert-info",this.message.innerText="Initializing...",this.progress.style.width="100%",this.progress.className="progress-bar progress-bar-striped progress-bar-animated";const t=new Uint8Array(e);this.callback(t)}onError(e){throw this.alert.className="alert alert-danger",this.message.innerText="An error occurred while parsing SoundFont. See the console log for details. In addition, it may be cured by deleting the cache of the browser.",this.progressOuter.style.display="none",Error(e)}async fetch(){const e=await window.caches.open("wml"),t=await e.match(this.url);if(this.cache&&t){this.onComplete(await t.arrayBuffer());return}const n=await fetch(this.url,{method:"GET",mode:"no-cors",credentials:"include",headers:{"Access-Control-Allow-Origin":"*"}}),s=parseInt(n.headers.get("Content-Length")),i=n.clone(),o=n.clone(),r=n.body.getReader();for(;;){const{done:h,value:l}=await r.read();if(h)break;this.message.innerText=`Now Loading... (${l.length} byte)`,s!==0&&this.onProgress(l.length,s)}n.ok&&this.cache&&e.add(i),this.onComplete(await o.arrayBuffer())}}class W{constructor(e={}){this.NrpnMsb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.NrpnLsb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.RpnMsb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.RpnLsb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.ready=!1,this.synth=void 0,this.loadCallback=void 0,this.messageHandler=this.onmessage.bind(this),this.rpnMode=!0,this.option=e,this.option.drawSynth=e.drawSynth!==void 0?e.drawSynth:!0,this.option.cache=e.cache||!1,this.placeholder=e.placeholder!==void 0?document.getElementById(e.placeholder):window.document.body,this.window=null,window.opener?this.window=window.opener:window.parent!==window?this.window=window.parent:this.window=window}async setup(e){await new ge(e,this.placeholder,this.option.cache,t=>this.setupByBuffer(t)).fetch()}setupByBuffer(e){for(;this.placeholder.firstChild;)this.placeholder.removeChild(this.placeholder.firstChild);if(this.synth)this.synth.refreshInstruments(e);else{if(this.synth=new fe(e),this.option.drawSynth)this.placeholder.appendChild(this.synth.drawSynth());else{const t=document.createElement("strong");t.innerText="Ready.",this.placeholder.appendChild(t)}this.synth.init(),this.synth.start()}this.onReady()}onReady(){window.removeEventListener("message",this.messageHandler),this.loadCallback&&this.loadCallback(),window.addEventListener("message",this.messageHandler,!1),this.window.postMessage("link,ready","*")}onmessage(e){const t=typeof e.data.split=="function"?e.data.split(","):[],n=t!==[]?t.shift():"";let s;switch(n){case"midi":this.processMidiMessage(t.map(i=>parseInt(i,16)));break;case"link":if(this.window===void 0)return;switch(s=t.shift(),s){case"reqpatch":this.window.postMessage("link,patch","*");break;case"setpatch":case"ready":this.window.postMessage("link,ready","*");break;case"progress":this.window.postMessage("link,progress","*");break}break}}setLoadCallback(e){this.loadCallback=e}processMidiMessage(e){const t=e[0]&15,n=this.synth;switch(e[0]&240){case 128:n.noteOff(t,e[1],e[2]);break;case 144:e[2]>0?n.noteOn(t,e[1],e[2]):n.noteOff(t,e[1],0);break;case 176:{const s=e[2];switch(e[1]){case 0:n.bankSelectMsb(t,s);break;case 1:n.modulationDepth(t,s);break;case 5:break;case 6:if(this.rpnMode)switch(this.RpnMsb[t]){case 0:switch(this.RpnLsb[t]){case 0:n.pitchBendSensitivity(t,s);break}break}else switch(this.NrpnMsb[t]){case 26:n.drumInstrumentLevel(this.NrpnLsb[t],s);break}break;case 38:if(this.rpnMode)switch(this.RpnMsb[t]){case 0:switch(this.RpnLsb[t]){case 0:n.pitchBendSensitivity(t,n.getPitchBendSensitivity(t)+s/100);break}break}break;case 7:n.volumeChange(t,s);break;case 10:n.panpotChange(t,s);break;case 120:n.allSoundOff(t);break;case 121:n.resetAllControl(t);break;case 32:n.bankSelectLsb(t,s);break;case 71:n.harmonicContent(t,s);break;case 96:break;case 97:break;case 98:this.rpnMode=!1,this.NrpnLsb[t]=s;break;case 99:this.rpnMode=!1,this.NrpnMsb[t]=s;break;case 100:this.rpnMode=!0,this.RpnLsb[t]=s;break;case 101:this.rpnMode=!0,this.RpnMsb[t]=s;break;case 64:n.hold(t,s);break;case 11:n.expression(t,s);break;case 72:n.decayTime(t,s);break;case 73:n.releaseTime(t,s);break;case 74:n.attackTime(t,s);break;case 75:n.cutOffFrequency(t,s);break;case 91:n.reverbDepth(t,s);break}break}case 192:n.programChange(t,e[1]);break;case 224:n.pitchBend(t,e[1],e[2]);break;case 240:{const s=e[2],i=e[3],o=e[4];if(s===126||i===9)switch(o){case 1:n.init("GM");break;case 2:break;case 3:n.init("GM2");break}else if(s===127)e[4]===1&&n.setMasterVolume(e[5]+(e[6]<<7));else if(s===65){const r=e[7]-15;switch(e[8]){case 0:if(e[7]===0){const h=e.splice(8);h.pop(),h.pop(),n.processMidiMessage(h)}break;case 4:n.setMasterVolume(e[9]*64);break;case 21:{const h=e[8];r===0?n.setPercussionPart(9,h!==0):r>=10?n.setPercussionPart(r-1,h!==0):n.setPercussionPart(r,h!==0);break}case 25:break;case 48:break;case 56:break;case 69:break;case 127:n.init("GS");break}}else if(s==67)switch(e[2]!==67&&e[3]===67&&e.splice(1,1),e[5]){case 0:e[7]===126&&n.init("XG");break;case 2:break;case 4:n.setMasterVolume(e[9]*64);break;case 6:{const r=e.splice(8);r.pop(),n.processMidiMessage(r);break}case 7:break;case 8:n.setPercussionPart(e[6],e[8]!==0);break}break}default:n.setPercussionPart(9,!0);break}}dumpMessage(e){const t=[];for(const n of e)t.push(n.toString(16).toUpperCase());return t.join(" ")}}class ye extends W{constructor(e={}){super(e),this.midi=void 0}async setup(e){this.midi=await navigator.requestMIDIAccess({sysex:!0}),await super.setup(e)}onReady(){super.loadCallback&&super.loadCallback(),this.midi.onmidimessage=e=>super.processMidiMessage(e)}}const H={version:"0.4.10",date:"2022-10-04T11:57:08.114Z"},P={version:H.version,build:H.date,WebMidiLink:W,WebMidiApi:ye,Parser:U};window.SoundFont||(window.SoundFont=P);const N=document.getElementById("file"),Z=document.getElementById("drop"),ve=document.getElementById("build"),be=document.getElementById("name");window.addEventListener("DOMContentLoaded",async()=>{const a=Q.parse(window.location.search),e={placeholder:"placeholder"};a.ui==="false"&&(e.drawSynth=!1);const t=new P.WebMidiLink(e);ve.innerText=new Date(P.build).toLocaleString();const n=a.soundfont?a.soundfont:{VITE_GOOGLE_ANALYTICS_ID:"UA-33600926-1",VITE_WML_URL:"https://logue.dev/sf2synth.js/wml.html?soundfont=Yamaha XG Sound Set Ver.2.0.sf2",BASE_URL:"./",MODE:"production",DEV:!1,PROD:!0}.VITE_SOUNDFONT_URL||"./Yamaha XG Sound Set.sf2";be.innerText=n.match(/^http/)?new URL(n).pathname.substring(n.lastIndexOf("/")+1):n,await t.setup(n);const s=i=>{const o=new FileReader;o.readAsArrayBuffer(i),o.onload=r=>{document.getElementById("soundfont").innerText=i.name;const h=new Uint8Array(r.target.result);t.setupByBuffer(h)}};N.addEventListener("change",i=>{i.preventDefault(),s(N.files[0]),N.value=""}),Z.addEventListener("dragover",i=>i.preventDefault(),!0),Z.addEventListener("drop",i=>{const r=i.dataTransfer.files;i.stopPropagation(),i.preventDefault(),s(r[0])},!0)},!1);((a,e,t,n,s)=>{a[n]=a[n]||[],a[n].push({"gtm.start":new Date().getTime(),event:"gtm.js"});const i=e.getElementsByTagName(t)[0],o=e.createElement(t),r=n!="dataLayer"?"&l="+n:"";o.async=!0,o.src="https://www.googletagmanager.com/gtm.js?id="+s+r,i.parentNode.insertBefore(o,i)})(window,document,"script","dataLayer","UA-33600926-1");
