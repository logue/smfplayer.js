import{q as K}from"./index.9dd16a71.js";/**
 * @logue/sf2synth
 *
 * @description SoundFont2 Synthesizer
 * @author iyama, Logue
 * @license MIT
 * @version 0.4.12
 * @see {@link https://github.com/logue/sf2synth.js}
 */class Y{constructor(e,t,s){this.ctx=e,this.destination=t,this.instrument=s,this.channel=s.channel,this.key=s.key,this.velocity=s.velocity,this.buffer=s.sample,this.playbackRate=s.basePlaybackRate,this.loopStart=s.loopStart,this.loopEnd=s.loopEnd,this.sampleRate=s.sampleRate,this.volume=s.volume,this.panpot=s.panpot,this.pitchBend=s.pitchBend,this.pitchBendSensitivity=s.pitchBendSensitivity,this.modEnvToPitch=s.modEnvToPitch,this.expression=s.expression,this.modulation=s.modulation,this.cutOffFrequency=s.cutOffFrequency,this.hermonicContent=s.hermonicContent,this.reverb=s.reverb,this.startTime=e.currentTime,this.computedPlaybackRate=this.playbackRate|0,this.noteOffState=!1,this.audioBuffer=null,this.bufferSource=e.createBufferSource(),this.panner=e.createPanner(),this.outputGainNode=e.createGain(),this.expressionGainNode=e.createGain(),this.filter=e.createBiquadFilter(),this.modulator=e.createBiquadFilter()}noteOn(){const e=this.ctx,t=this.instrument,s=this.ctx.currentTime||0,n=s+t.volDelay,i=s+t.modDelay,o=n+t.volAttack,r=n+t.modAttack,c=o+t.volHold,l=r+t.modHold,h=c+t.volDecay,m=l+t.modDecay,u=t.loopStart/this.sampleRate,d=t.loopEnd/this.sampleRate,p=t.start/this.sampleRate,f=t.pan!==0?t.pan:this.panpot,g=this.buffer.subarray(0,this.buffer.length+t.end),y=this.audioBuffer=e.createBuffer(1,g.length,this.sampleRate);y.getChannelData(0).set(g);const b=this.bufferSource;b.buffer=y,b.loop=t.sampleModes||0,b.loopStart=u,b.loopEnd=d,this.updatePitchBend(this.pitchBend);const k=this.outputGainNode;this.expressionGainNode.gain.value=this.expression/127;const M=this.panner;M.panningModel="equalpower",M.distanceModel="inverse",M.setPosition(Math.sin(f*Math.PI/2),0,Math.cos(f*Math.PI/2));let S=this.volume*(this.velocity/127)*(1-t.initialAttenuation/1e3);S<0&&(S=0);const w=k.gain;w.setValueAtTime(0,s),w.setValueAtTime(0,n),w.setTargetAtTime(S,n,t.volAttack),w.setValueAtTime(S,c),w.linearRampToValueAtTime(S*(1-t.volSustain),h);const C=t.initialFilterFc,N=t.initialFilterFc+t.modEnvToFilterFc,Q=C+(N-C)*(1-t.modSustain),E=this.modulator;E.Q.setValueAtTime(10**(t.initialFilterQ/200),s),E.frequency.value=C,E.type="lowpass",E.frequency.setTargetAtTime(C/127,this.ctx.currentTime,.5),E.frequency.setValueAtTime(C,s),E.frequency.setValueAtTime(C,i),E.frequency.setTargetAtTime(N,i,parseFloat(t.modAttack)),E.frequency.setValueAtTime(N,l),E.frequency.exponentialRampToValueAtTime(Q,m),b.connect(E),E.connect(M),M.connect(this.expressionGainNode),t.mute||this.connect(),this.expressionGainNode.connect(k),b.start(0,p)}amountToFreq(e){return 2**((e-6900)/1200)*440}noteOff(){this.noteOffState=!0}isNoteOff(){return this.noteOffState}release(){const e=this.instrument,t=this.bufferSource,s=this.outputGainNode,n=this.ctx.currentTime,i=e.releaseTime-64,o=e.volRelease*s.gain.value,r=n+o*(1+i/(i<0?64:63)),c=this.modulator,l=e.initialFilterFc,h=e.initialFilterFc+e.modEnvToFilterFc,m=n+e.modRelease*(l===h?1:(c.frequency.value-l)/(h-l));if(!!this.audioBuffer)switch(e.sampleModes){case 0:t.loop=!1;break;case 1:s.gain.cancelScheduledValues(0),s.gain.setValueAtTime(s.gain.value,n),s.gain.linearRampToValueAtTime(0,r),c.frequency.cancelScheduledValues(0),c.frequency.setValueAtTime(c.frequency.value,n),c.frequency.exponentialRampToValueAtTime(l,m),t.playbackRate.cancelScheduledValues(0),t.playbackRate.setValueAtTime(t.playbackRate.value,n),t.playbackRate.exponentialRampToValueAtTime(this.computedPlaybackRate,m),t.stop(r);break;case 2:throw Error("[SynthesizerNote] Detect unused sampleModes");case 3:s.gain.cancelScheduledValues(0),s.gain.setValueAtTime(s.gain.value,n),s.gain.linearRampToValueAtTime(0,r),c.frequency.cancelScheduledValues(0),c.frequency.setValueAtTime(c.frequency.value,n),c.frequency.exponentialRampToValueAtTime(l,m),t.playbackRate.cancelScheduledValues(0),t.playbackRate.setValueAtTime(t.playbackRate.value,n),t.playbackRate.exponentialRampToValueAtTime(this.computedPlaybackRate,m),t.loop=!1,t.buffer=null;break;default:throw Error(`[SynthesizerNote] ${e.sampleModes} is undefined sampleModes.`)}}connect(){this.reverb.connect(this.outputGainNode).connect(this.destination)}disconnect(){this.outputGainNode.disconnect(0)}schedulePlaybackRate(){const e=this.bufferSource.playbackRate,t=this.computedPlaybackRate,s=this.startTime,n=this.instrument,i=s+n.modAttack,o=i+n.modDecay,r=t*1.0594630943592953**(this.modEnvToPitch*this.instrument.scaleTuning);e.cancelScheduledValues(0),e.setValueAtTime(t,s),e.linearRampToValueAtTime(r,i),e.linearRampToValueAtTime(t+(r-t)*(1-n.modSustain),o)}updateExpression(e){this.expressionGainNode.gain.value=(this.expression=e)/127}updatePitchBend(e){this.computedPlaybackRate=this.playbackRate*1.0594630943592953**(e/(e<0?8192:8191)*this.pitchBendSensitivity*this.instrument.scaleTuning),this.schedulePlaybackRate()}}/**
 * @logue/reverb
 *
 * @description JavaScript Reverb effect class
 * @author Logue <logue@hotmail.co.jp>
 * @copyright 2019-2022 By Masashi Yoshikawa All rights reserved.
 * @license MIT
 * @version 1.1.2
 * @see {@link https://github.com/logue/Reverb.js}
 */const x={BLUE:"blue",GREEN:"green",PINK:"pink",RED:"red",VIOLET:"violet",WHITE:"white",BROWN:"red"},H=1/2**32;class J{float(e=1){return this.int()*H*e}norm(e=1){return(this.int()*H-.5)*2*e}minmax(e,t){return this.float()*(t-e)+e}minmaxInt(e,t){return e|=0,t|=0,e+(this.float()*(t-e)|0)}}const O=Math.random;class ee extends J{int(){return O()*4294967296>>>0}float(e=1){return O()*e}norm(e=1){return(O()-.5)*2*e}}const A=new ee,te={noise:x.WHITE,scale:1,peaks:2,randomAlgorithm:A,decay:2,delay:0,reverse:!1,time:2,filterType:"allpass",filterFreq:2200,filterQ:1,mix:.5,once:!1},z={version:"1.1.2",date:"2022-11-06T12:24:34.397Z"},V=(a,e,t)=>{const s=new Array(a);for(let n=0;n<a;n++)s[n]=t.norm(e);return s},F=a=>a.reduce((e,t)=>e+t,0);function*U(a,e){const t=[a[Symbol.iterator](),e[Symbol.iterator]()];for(let s=0;;s^=1){const n=t[s].next();if(n.done)return;yield n.value}}function*L(a=2,e=1,t=A){const s=V(a,e,t);s.forEach((o,r)=>s[r]=r&1?o:-o);const n=1/a;let i=F(s);for(let o=0,r=-1;;++o>=a&&(o=0))i-=s[o],i+=s[o]=r*t.norm(e),r^=4294967294,yield r*i*n}const se=(a=2,e=1,t=A)=>U(L(a,e,t),L(a,e,t)),ne=a=>{let e=32;return a&=-a,a&&e--,a&65535&&(e-=16),a&16711935&&(e-=8),a&252645135&&(e-=4),a&858993459&&(e-=2),a&1431655765&&(e-=1),e};function*ie(a=8,e=1,t=A){const s=V(a,e,t),n=1/a;let i=F(s);for(let o=0;;o=o+1>>>0){const r=ne(o)%a;i-=s[r],i+=s[r]=t.norm(e),yield i*n}}function*P(a=2,e=1,t=A){const s=V(a,e,t),n=1/a;let i=F(s);for(let o=0;;++o>=a&&(o=0))i-=s[o],i+=s[o]=t.norm(e),yield i*n}const oe=(a=2,e=1,t=A)=>U(P(a,e,t),P(a,e,t));function*G(a=1,e=A){for(;;)yield e.norm(a)}const re=(a,e)=>a!=null&&typeof a[e]=="function",ae=a=>re(a,"xform")?a.xform():a,le=a=>a!=null&&typeof a[Symbol.iterator]=="function";class R{constructor(e){this.value=e}deref(){return this.value}}const ce=a=>new R(a),he=a=>a instanceof R,de=a=>a instanceof R?a:new R(a),j=a=>a instanceof R?a.deref():a,ue=(a,e)=>[a,t=>t,e];function pe(a){return a?[...a]:ue(()=>[],(e,t)=>(e.push(t),e))}function*me(a,e){const t=ae(a)(pe()),s=t[1],n=t[2];for(let i of e){const o=n([],i);if(he(o)){yield*j(s(o.deref()));return}o.length&&(yield*o)}yield*j(s([]))}const fe=(a,e)=>[a[0],a[1],e];function $(a,e){return le(e)?me($(a),e):t=>{const s=t[2];let n=a;return fe(t,(i,o)=>--n>0?s(i,o):n===0?de(s(i,o)):ce(i))}}class I{constructor(e,t){this.noise=G,this.ctx=e,this.options={...te,...t},this.wetGainNode=this.ctx.createGain(),this.dryGainNode=this.ctx.createGain(),this.filterNode=this.ctx.createBiquadFilter(),this.convolverNode=this.ctx.createConvolver(),this.outputNode=this.ctx.createGain(),this.isConnected=!1,this.filterType(this.options.filterType),this.setNoise(this.options.noise),this.buildImpulse(),this.mix(this.options.mix)}connect(e){return this.isConnected&&this.options.once?(this.isConnected=!1,this.outputNode):(this.convolverNode.connect(this.filterNode),this.filterNode.connect(this.wetGainNode),e.connect(this.convolverNode),e.connect(this.dryGainNode).connect(this.outputNode),e.connect(this.wetGainNode).connect(this.outputNode),this.isConnected=!0,this.outputNode)}disconnect(e){return this.isConnected&&(this.convolverNode.disconnect(this.filterNode),this.filterNode.disconnect(this.wetGainNode)),this.isConnected=!1,e}mix(e){if(!this.inRange(e,0,1))throw new RangeError("[Reverb.js] Dry/Wet ratio must be between 0 to 1.");this.options.mix=e,this.dryGainNode.gain.value=1-this.options.mix,this.wetGainNode.gain.value=this.options.mix}time(e){if(!this.inRange(e,1,50))throw new RangeError("[Reverb.js] Time length of inpulse response must be less than 50sec.");this.options.time=e,this.buildImpulse()}decay(e){if(!this.inRange(e,0,100))throw new RangeError("[Reverb.js] Inpulse Response decay level must be less than 100.");this.options.decay=e,this.buildImpulse()}delay(e){if(!this.inRange(e,0,100))throw new RangeError("[Reverb.js] Inpulse Response delay time must be less than 100.");this.options.delay=e,this.buildImpulse()}reverse(e){this.options.reverse=e,this.buildImpulse()}filterType(e="allpass"){this.filterNode.type=this.options.filterType=e}filterFreq(e){if(!this.inRange(e,20,2e4))throw new RangeError("[Reverb.js] Filter frequrncy must be between 20 and 20000.");this.options.filterFreq=e,this.filterNode.frequency.value=this.options.filterFreq}filterQ(e){if(!this.inRange(e,0,10))throw new RangeError("[Reverb.js] Filter quality value must be between 0 and 10.");this.options.filterQ=e,this.filterNode.Q.value=this.options.filterQ}peaks(e){this.options.peaks=e,this.buildImpulse()}scale(e){this.options.scale=e,this.buildImpulse()}randomAlgorithm(e){this.options.randomAlgorithm=e,this.buildImpulse()}setNoise(e){switch(this.options.noise=e,e){case x.BLUE:this.noise=L;break;case x.GREEN:this.noise=se;break;case x.PINK:this.noise=ie;break;case x.RED:case x.BROWN:this.noise=P;break;case x.VIOLET:this.noise=oe;break;default:this.noise=G}this.buildImpulse()}setRandomAlgorythm(e){this.options.randomAlgorithm=e,this.buildImpulse()}inRange(e,t,s){return(e-t)*(e-s)<=0}buildImpulse(){const e=this.ctx.sampleRate,t=Math.max(e*this.options.time,1),s=e*this.options.delay,n=this.ctx.createBuffer(2,t,e),i=new Float32Array(t),o=new Float32Array(t),r=this.getNoise(t),c=this.getNoise(t);for(let l=0;l<t;l++){let h=0;l<s?(i[l]=0,o[l]=0,h=this.options.reverse?t-(l-s):l-s):h=this.options.reverse?t-l:l,i[l]=r[l]*(1-h/t)**this.options.decay,o[l]=c[l]*(1-h/t)**this.options.decay}n.getChannelData(0).set(i),n.getChannelData(1).set(o),this.convolverNode.buffer=n}getNoise(e){return[...$(e,this.noise===G?G(this.options.scale,this.options.randomAlgorithm):this.noise(this.options.peaks,this.options.scale,this.options.randomAlgorithm))]}}I.version=z.version;I.build=z.date;window.Reverb||(window.Reverb=I);class T{constructor(e,t={}){this.input=e,this.ip=t.index||0,this.length=t.length||e.length-this.ip,this.chunkList=[],this.offset=this.ip,this.padding=t.padding!==void 0?t.padding:!0,this.bigEndian=t.bigEndian!==void 0?t.bigEndian:!1}parse(){const e=this.length+this.offset;for(this.chunkList=[];this.ip<e;)this.parseChunk()}parseChunk(){const e=this.input;let t=this.ip,s;this.chunkList.push(new ge(String.fromCharCode(e[t++],e[t++],e[t++],e[t++]),s=this.bigEndian?(e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++])>>>0:(e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24)>>>0,t)),t+=s,this.padding&&(t-this.offset&1)===1&&t++,this.ip=t}getChunk(e){const t=this.chunkList[e];return t===void 0?null:t}getNumberOfChunks(){return this.chunkList.length}}class ge{constructor(e,t,s){this.type=e,this.size=t,this.offset=s}}class W{constructor(e,t={}){this.input=e,this.parserOption=t.parserOption||{},this.sampleRate=t.sampleRate||22050,this.presetHeader=[],this.presetZone=[],this.presetZoneModulator=[],this.presetZoneGenerator=[],this.instrument=[],this.instrumentZone=[],this.instrumentZoneModulator=[],this.instrumentZoneGenerator=[],this.sampleHeader=[],this.GeneratorEnumeratorTable=Object.keys(this.getGeneratorTable())}getGeneratorTable(){return Object.freeze({startAddrsOffset:0,endAddrsOffset:0,startloopAddrsOffset:0,endloopAddrsOffset:0,startAddrsCoarseOffset:0,modLfoToPitch:0,vibLfoToPitch:0,modEnvToPitch:0,initialFilterFc:13500,initialFilterQ:0,modLfoToFilterFc:0,modEnvToFilterFc:0,endAddrsCoarseOffset:0,modLfoToVolume:0,unused1:void 0,chorusEffectsSend:0,reverbEffectsSend:0,pan:0,unused2:void 0,unused3:void 0,unused4:void 0,delayModLFO:-12e3,freqModLFO:0,delayVibLFO:-12e3,freqVibLFO:0,delayModEnv:-12e3,attackModEnv:-12e3,holdModEnv:-12e3,decayModEnv:-12e3,sustainModEnv:0,releaseModEnv:-12e3,keynumToModEnvHold:0,keynumToModEnvDecay:0,delayVolEnv:-12e3,attackVolEnv:-12e3,holdVolEnv:-12e3,decayVolEnv:-12e3,sustainVolEnv:0,releaseVolEnv:-12e3,keynumToVolEnvHold:0,keynumToVolEnvDecay:0,instrument:null,reserved1:void 0,keyRange:null,velRange:null,startloopAddrsCoarseOffset:0,keynum:null,velocity:null,initialAttenuation:0,reserved2:void 0,endloopAddrsCoarseOffset:0,coarseTune:0,fineTune:0,sampleID:null,sampleModes:0,reserved3:void 0,scaleTuning:100,exclusiveClass:null,overridingRootKey:null,unuded5:void 0,endOper:void 0})}parse(){const e=new T(this.input,this.parserOption);if(e.parse(),e.chunkList.length!==1)throw new Error("wrong chunk length");const t=e.getChunk(0);if(t===null)throw new Error("chunk not found");this.parseRiffChunk(t),this.input=null}parseRiffChunk(e){const t=this.input;let s=e.offset;if(e.type!=="RIFF")throw new Error("invalid chunk type:"+e.type);const n=String.fromCharCode(t[s++],t[s++],t[s++],t[s++]);if(n!=="sfbk")throw new Error("invalid signature:"+n);const i=new T(t,{index:s,length:e.size-4});if(i.parse(),i.getNumberOfChunks()!==3)throw new Error("invalid sfbk structure");this.parseInfoList(i.getChunk(0)),this.parseSdtaList(i.getChunk(1)),this.parsePdtaList(i.getChunk(2))}parseInfoList(e){const t=this.input;let s=e.offset;if(e.type!=="LIST")throw new Error("invalid chunk type:"+e.type);const n=String.fromCharCode(t[s++],t[s++],t[s++],t[s++]);if(n!=="INFO")throw new Error("invalid signature:"+n);new T(t,{index:s,length:e.size-4}).parse()}parseSdtaList(e){const t=this.input;let s=e.offset;if(e.type!=="LIST")throw new Error("invalid chunk type:"+e.type);const n=String.fromCharCode(t[s++],t[s++],t[s++],t[s++]);if(n!=="sdta")throw new Error("invalid signature:"+n);const i=new T(t,{index:s,length:e.size-4});if(i.parse(),i.chunkList.length!==1)throw new Error("TODO");this.samplingData=i.getChunk(0)}parsePdtaList(e){const t=this.input;let s=e.offset;if(e.type!=="LIST")throw new Error("invalid chunk type:"+e.type);const n=String.fromCharCode(t[s++],t[s++],t[s++],t[s++]);if(n!=="pdta")throw new Error("invalid signature:"+n);const i=new T(t,{index:s,length:e.size-4});if(i.parse(),i.getNumberOfChunks()!==9)throw new Error("invalid pdta chunk");this.parsePhdr(i.getChunk(0)),this.parsePbag(i.getChunk(1)),this.parsePmod(i.getChunk(2)),this.parsePgen(i.getChunk(3)),this.parseInst(i.getChunk(4)),this.parseIbag(i.getChunk(5)),this.parseImod(i.getChunk(6)),this.parseIgen(i.getChunk(7)),this.parseShdr(i.getChunk(8))}parsePhdr(e){const t=this.input;let s=e.offset;const n=this.presetHeader=[],i=e.offset+e.size;if(e.type!=="phdr")throw new Error("invalid chunk type:"+e.type);for(;s<i;)n.push({presetName:String.fromCharCode.apply(null,t.subarray(s,s+=20)),preset:t[s++]|t[s++]<<8,bank:t[s++]|t[s++]<<8,presetBagIndex:t[s++]|t[s++]<<8,library:(t[s++]|t[s++]<<8|t[s++]<<16|t[s++]<<24)>>>0,genre:(t[s++]|t[s++]<<8|t[s++]<<16|t[s++]<<24)>>>0,morphology:(t[s++]|t[s++]<<8|t[s++]<<16|t[s++]<<24)>>>0})}parsePbag(e){const t=this.input;let s=e.offset;const n=this.presetZone=[],i=e.offset+e.size;if(e.type!=="pbag")throw new Error("invalid chunk type:"+e.type);for(;s<i;)n.push({presetGeneratorIndex:t[s++]|t[s++]<<8,presetModulatorIndex:t[s++]|t[s++]<<8})}parsePmod(e){if(e.type!=="pmod")throw new Error("invalid chunk type:"+e.type);this.presetZoneModulator=this.parseModulator(e)}parsePgen(e){if(e.type!=="pgen")throw new Error("invalid chunk type:"+e.type);this.presetZoneGenerator=this.parseGenerator(e)}parseInst(e){const t=this.input;let s=e.offset;const n=this.instrument=[],i=e.offset+e.size;if(e.type!=="inst")throw new Error("invalid chunk type:"+e.type);for(;s<i;)n.push({instrumentName:String.fromCharCode.apply(null,t.subarray(s,s+=20)),instrumentBagIndex:t[s++]|t[s++]<<8})}parseIbag(e){const t=this.input;let s=e.offset;const n=this.instrumentZone=[],i=e.offset+e.size;if(e.type!=="ibag")throw new Error("invalid chunk type:"+e.type);for(;s<i;)n.push({instrumentGeneratorIndex:t[s++]|t[s++]<<8,instrumentModulatorIndex:t[s++]|t[s++]<<8})}parseImod(e){if(e.type!=="imod")throw new Error("invalid chunk type:"+e.type);this.instrumentZoneModulator=this.parseModulator(e)}parseIgen(e){if(e.type!=="igen")throw new Error("invalid chunk type:"+e.type);this.instrumentZoneGenerator=this.parseGenerator(e)}parseShdr(e){const t=this.input;let s=e.offset;const n=this.sample=[],i=this.sampleHeader=[],o=e.offset+e.size;let r,c,l,h,m,u,d,p,f,g;if(e.type!=="shdr")throw new Error("invalid chunk type:"+e.type);for(;s<o;){r=String.fromCharCode.apply(null,t.subarray(s,s+=20)),c=(t[s++]<<0|t[s++]<<8|t[s++]<<16|t[s++]<<24)>>>0,l=(t[s++]<<0|t[s++]<<8|t[s++]<<16|t[s++]<<24)>>>0,h=(t[s++]<<0|t[s++]<<8|t[s++]<<16|t[s++]<<24)>>>0,m=(t[s++]<<0|t[s++]<<8|t[s++]<<16|t[s++]<<24)>>>0,u=(t[s++]<<0|t[s++]<<8|t[s++]<<16|t[s++]<<24)>>>0,d=t[s++],p=t[s++]<<24>>24,f=t[s++]|t[s++]<<8,g=t[s++]|t[s++]<<8;let y=new Int16Array(new Uint8Array(t.subarray(this.samplingData.offset+c*2,this.samplingData.offset+l*2)).buffer);if(h-=c,m-=c,u>0){const v=this.adjustSampleData(y,u);y=v.sample,u*=v.multiply,h*=v.multiply,m*=v.multiply}n.push(y),i.push({sampleName:r,start:c,end:l,startLoop:h,endLoop:m,sampleRate:u,originalPitch:d,pitchCorrection:p,sampleLink:f,sampleType:g})}}adjustSampleData(e,t){let s,n,i,o,r=1;for(;t<this.sampleRate;){for(s=new Int16Array(e.length*2),n=o=0,i=e.length;n<i;++n)s[o++]=e[n],s[o++]=e[n];e=s,r*=2,t*=2}return{sample:e,multiply:r}}parseModulator(e){const t=this.input;let s=e.offset;const n=e.offset+e.size;let i,o;const r=[];for(;s<n;){if(s+=2,i=t[s++]|t[s++]<<8,o=this.GeneratorEnumeratorTable[i],o===void 0)r.push({type:o,value:{code:i,amount:t[s]|t[s+1]<<8<<16>>16,lo:t[s++],hi:t[s++]}});else switch(o){case"keyRange":case"velRange":case"keynum":case"velocity":r.push({type:o,value:{amount:null,lo:t[s++],hi:t[s++]}});break;default:r.push({type:o,value:{amount:t[s++]|t[s++]<<8<<16>>16}});break}s+=2,s+=2}return r}parseGenerator(e){const t=this.input;let s=e.offset;const n=e.offset+e.size;let i,o;const r=[];for(;s<n;){if(i=t[s++]|t[s++]<<8,o=this.GeneratorEnumeratorTable[i],o===void 0){r.push({type:o,value:{code:i,amount:t[s]|t[s+1]<<8<<16>>16,lo:t[s++],hi:t[s++]}});continue}switch(o){case"keynum":case"keyRange":case"velRange":case"velocity":r.push({type:o,value:{amount:null,lo:t[s++],hi:t[s++]}});break;default:r.push({type:o,value:{amount:t[s++]|t[s++]<<8<<16>>16}});break}}return r}createInstrument(){const e=this.instrument,t=this.instrumentZone,s=[];let n,i,o,r,c,l,h,m,u;for(l=0,h=e.length;l<h;++l){for(n=e[l].instrumentBagIndex,i=e[l+1]?e[l+1].instrumentBagIndex:t.length,o=[],m=n,u=i;m<u;++m)r=this.createInstrumentGenerator_(t,m),c=this.createInstrumentModulator_(t,m),o.push({generator:r.generator,generatorSequence:r.generatorInfo,modulator:c.modulator,modulatorSequence:c.modulatorInfo});s.push({name:e[l].instrumentName,info:o})}return s}createPreset(){const e=this.presetHeader,t=this.presetZone,s=[];let n,i,o,r,c,l,h,m,u,d;for(h=0,m=e.length;h<m;++h){for(n=e[h].presetBagIndex,i=e[h+1]?e[h+1].presetBagIndex:t.length,o=[],u=n,d=i;u<d;++u)c=this.createPresetGenerator_(t,u),l=this.createPresetModulator_(t,u),o.push({generator:c.generator,generatorSequence:c.generatorInfo,modulator:l.modulator,modulatorSequence:l.modulatorInfo}),r=c.generator.instrument!==void 0?c.generator.instrument.amount:l.modulator.instrument!==void 0?l.modulator.instrument.amount:null;s.push({name:e[h].presetName,info:o,header:e[h],instrument:r})}return s}createInstrumentGenerator_(e,t){const s=this.createBagModGen_(e,e[t].instrumentGeneratorIndex,e[t+1]?e[t+1].instrumentGeneratorIndex:this.instrumentZoneGenerator.length,this.instrumentZoneGenerator);return{generator:s.modgen,generatorInfo:s.modgenInfo}}createInstrumentModulator_(e,t){const s=this.createBagModGen_(e,e[t].presetModulatorIndex,e[t+1]?e[t+1].instrumentModulatorIndex:this.instrumentZoneModulator.length,this.instrumentZoneModulator);return{modulator:s.modgen,modulatorInfo:s.modgenInfo}}createPresetGenerator_(e,t){const s=this.createBagModGen_(e,e[t].presetGeneratorIndex,e[t+1]?e[t+1].presetGeneratorIndex:this.presetZoneGenerator.length,this.presetZoneGenerator);return{generator:s.modgen,generatorInfo:s.modgenInfo}}createPresetModulator_(e,t){const s=this.createBagModGen_(e,e[t].presetModulatorIndex,e[t+1]?e[t+1].presetModulatorIndex:this.presetZoneModulator.length,this.presetZoneModulator);return{modulator:s.modgen,modulatorInfo:s.modgenInfo}}createBagModGen_(e,t,s,n){const i=[],o={unknown:[],keyRange:{amount:null,hi:127,lo:0}};let r,c,l;for(c=t,l=s;c<l;++c)r=n[c],i.push(r),r.type==="unknown"?o.unknown.push(r.value):o[r.type]=r.value;return{modgen:o,modgenInfo:i}}}class ye{constructor(e){let t,s;for(this.input=e,this.parser={},this.bank=0,this.bankSet={},this.bufferSize=2048,this.ctx=this.getAudioContext(),this.gainMaster=this.ctx.createGain(),this.bufSrc=this.ctx.createBufferSource(),this.channelInstrument=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.channelBank=[0,0,0,0,0,0,0,0,0,127,0,0,0,0,0,0],this.channelVolume=[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],this.channelPanpot=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelPitchBend=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.channelPitchBendSensitivity=[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],this.channelExpression=[127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127],this.channelAttack=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelDecay=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelSustin=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelRelease=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelHold=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.channelHarmonicContent=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelCutOffFrequency=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.mode="GM2",this.programSet=[],this.channelMute=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.currentNoteOn=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],this.baseVolume=1/65535,this.masterVolume=16384,this.percussionPart=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1],this.percussionVolume=new Array(128),t=0,s=this.percussionVolume.length;t<s;++t)this.percussionVolume[t]=127;for(this.programSet={},this.reverb=[],this.modulation=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.filter=[],t=0;t<16;++t)this.reverb[t]=new I(this.ctx,{noise:"violet",scale:1,peaks:2,filterType:"allpass"}),this.filter[t]=this.ctx.createBiquadFilter();this.items=[],this.intersection=new IntersectionObserver(n=>n.forEach(i=>i.target.dataset.isIntersecting=i.isIntersecting),{}),this.timer=null}getAudioContext(){const e=new AudioContext,t=()=>{document.removeEventListener("touchstart",t);const s=e.createBufferSource();s.start(),s.stop()};return document.addEventListener("touchstart",t),e}init(e="GM"){this.gainMaster.disconnect(),this.refreshInstruments(this.input),this.mode=e;for(let t=0;t<16;++t)this.setPercussionPart(t,t===9),this.programChange(t,0),this.volumeChange(t,100),this.panpotChange(t,64),this.pitchBend(t,0,64),this.pitchBendSensitivity(t,2),this.hold(t,0),this.expression(t,127),this.bankSelectMsb(t,t===9?127:0),this.bankSelectLsb(t,t===9?127:0),this.attackTime(t,64),this.decayTime(t,64),this.sustinTime(t,64),this.releaseTime(t,64),this.harmonicContent(t,64),this.cutOffFrequency(t,64),this.reverbDepth(t,40),this.modulationDepth(t,0),this.updateBankSelect(t),this.updateProgramSelect(t);this.setPercussionPart(9,!0);for(let t=0;t<128;++t)this.percussionVolume[t]=127;this.gainMaster.connect(this.ctx.destination),this.element&&(this.element.querySelector(".header .keys div").innerText=e+" Mode"),this.element.dataset.mode=e}close(){this.ctx.close()}refreshInstruments(e){this.input=e,this.parser=new W(e,{sampleRate:this.ctx.sampleRate}),this.bankSet=this.createAllInstruments()}createAllInstruments(){const e=this.parser;e.parse();const t=e.createPreset(),s=e.createInstrument(),n=[];let i,o,r,c,l,h,m,u,d,p;const f=[];for(h=0,m=t.length;h<m;++h)if(r=t[h],l=r.header.preset,o=r.header.bank,p=r.name.replace(/\0*$/,""),typeof r.instrument=="number"&&(c=s[r.instrument],c.name.replace(/\0*$/,"")!=="EOI")){for(n[o]===void 0&&(n[o]=[]),i=n[o],i[l]={},i[l].name=p,u=0,d=c.info.length;u<d;++u)this.createNoteInfo(e,c.info[u],i[l]);f[o]||(f[o]={}),f[o][l]=p}return this.programSet=f,n}createNoteInfo(e,t,s){const n=t.generator;if(!n.keyRange||!n.sampleID)return;const i=this.getModGenAmount(n,"delayVolEnv"),o=this.getModGenAmount(n,"attackVolEnv"),r=this.getModGenAmount(n,"holdVolEnv"),c=this.getModGenAmount(n,"decayVolEnv"),l=this.getModGenAmount(n,"sustainVolEnv"),h=this.getModGenAmount(n,"releaseVolEnv"),m=this.getModGenAmount(n,"delayModEnv"),u=this.getModGenAmount(n,"attackModEnv"),d=this.getModGenAmount(n,"holdModEnv"),p=this.getModGenAmount(n,"decayModEnv"),f=this.getModGenAmount(n,"sustainModEnv"),g=this.getModGenAmount(n,"releaseModEnv"),y=this.getModGenAmount(n,"scaleTuning")/100,v=this.getModGenAmount(n,"coarseTune")+this.getModGenAmount(n,"fineTune")/100,b=this.getModGenAmount(n,"sampleModes");for(let k=n.keyRange.lo,M=n.keyRange.hi;k<=M;++k){if(s[k])continue;const S=this.getModGenAmount(n,"sampleID"),w=e.sampleHeader[S];s[k]={sample:e.sample[S],sampleRate:w.sampleRate,sampleModes:b,basePlaybackRate:1.0594630943592953**((k-this.getModGenAmount(n,"overridingRootKey",w.originalPitch)+v+w.pitchCorrection/100)*y),modEnvToPitch:this.getModGenAmount(n,"modEnvToPitch")/100,scaleTuning:y,start:this.getModGenAmount(n,"startAddrsCoarseOffset")*32768+this.getModGenAmount(n,"startAddrsOffset"),end:this.getModGenAmount(n,"endAddrsCoarseOffset")*32768+this.getModGenAmount(n,"endAddrsOffset"),loopStart:w.startLoop+this.getModGenAmount(n,"startloopAddrsCoarseOffset")*32768+this.getModGenAmount(n,"startloopAddrsOffset"),loopEnd:w.endLoop+this.getModGenAmount(n,"endloopAddrsCoarseOffset")*32768+this.getModGenAmount(n,"endloopAddrsOffset"),volDelay:2**(i/1200),volAttack:2**(o/1200),volHold:2**(r/1200)*2**((60-k)*this.getModGenAmount(n,"keynumToVolEnvHold")/1200),volDecay:2**(c/1200)*2**((60-k)*this.getModGenAmount(n,"keynumToVolEnvDecay")/1200),volSustain:l/1e3,volRelease:2**(h/1200),modDelay:2**(m/1200),modAttack:2**(u/1200),modHold:2**(d/1200)*2**((60-k)*this.getModGenAmount(n,"keynumToModEnvHold")/1200),modDecay:2**(p/1200)*2**((60-k)*this.getModGenAmount(n,"keynumToModEnvDecay")/1200),modSustain:f/1e3,modRelease:2**(g/1200),initialFilterFc:8.176*Math.pow(2,this.getModGenAmount(n,"initialFilterFc")/1200),modEnvToFilterFc:this.getModGenAmount(n,"modEnvToFilterFc")/100,initialFilterQ:this.getModGenAmount(n,"initialFilterQ")/10,reverbEffectSend:this.getModGenAmount(n,"reverbEffectSend")/10,initialAttenuation:this.getModGenAmount(n,"initialAttenuation")/10,freqVibLFO:8.176*Math.pow(2,this.getModGenAmount(n,"freqVibLFO")/1200),pan:this.getModGenAmount(n,"pan")/1200}}}getModGenAmount(e,t){return e[t]?e[t].amount:this.parser.getGeneratorTable()[t]}start(){this.connect(),this.bufSrc.start(0),this.setMasterVolume(16383)}setMasterVolume(e){this.masterVolume=e,this.gainMaster.gain.value=this.baseVolume*(e/16384)}connect(){this.bufSrc.connect(this.gainMaster)}disconnect(){this.bufSrc.disconnect(this.gainMaster),this.bufSrc.buffer=null}drawSynth(){const e=window.document,t=this.element=e.createElement("div");t.className="synthesizer";const s=e.createElement("div");s.className="instrument",this.items=["mute","bank","program","volume","expression","panpot","pitchBend","pitchBendSensitivity","reverbDepth","keys"];const n="ontouchstart"in window?"touchstart":"mousedown",i="ontouchend"in window?"touchend":"mouseup";for(let l=0;l<16;l++){const h=e.createElement("div");h.className="channel",h.addEventListener(n,()=>{this.hold(l,0)});for(const m in this.items){if(!{}.hasOwnProperty.call(this.items,m))continue;const u=e.createElement("div");switch(u.className=this.items[m],this.items[m]){case"mute":{const d=e.createElement("div");d.className="form-check form-check-inline";const p=e.createElement("input");p.setAttribute("type","checkbox"),p.className="form-check-input",p.id="mute"+l+"ch",p.value=l,p.addEventListener("input",g=>{this.mute(l,g.target.checked)},!1),d.appendChild(p);const f=e.createElement("label");f.className="form-check-label",f.textContent=l+1,f.setAttribute("for","mute"+l+"ch"),d.appendChild(f),u.appendChild(d);break}case"bank":{const d=e.createElement("select");d.className="form-select form-select-sm",d.addEventListener("change",((p,f)=>g=>{const y=h.querySelector(".program select").value;p.bankChange(f,g.target.value),p.programChange(f,y)})(this,l),!1),u.appendChild(d);break}case"program":{const d=e.createElement("select");d.className="form-select form-select-sm",d.addEventListener("change",((p,f)=>g=>{p.programChange(f,g.target.value)})(this,l),!1),u.appendChild(d);break}case"volume":{const d=document.createElement("var");d.innerText=100,u.appendChild(d);break}case"expression":{const d=document.createElement("var");d.innerText=127,u.appendChild(d);break}case"pitchBendSensitivity":{const d=document.createElement("var");d.innerText=2,u.appendChild(d);break}case"reverbDepth":{const d=document.createElement("var");d.innerText=40,u.appendChild(d);break}case"panpot":{const d=e.createElement("div");d.className="progress";const p=e.createElement("div");p.className="progress-bar",d.appendChild(p),u.appendChild(d);break}case"pitchBend":{const d=e.createElement("div");d.className="progress";const p=e.createElement("div");p.className="progress-bar progress-bar-animated",d.appendChild(p),u.appendChild(d);break}case"keys":{for(let d=0;d<127;d++){const p=e.createElement("div"),f=d%12;p.className="key "+([1,3,6,8,10].includes(f)?"semitone":"tone"),u.appendChild(p),p.addEventListener(n,((g,y,v)=>b=>{b.preventDefault(),g.drag=!0,g.noteOn(y,v,127)})(this,l,d)),p.addEventListener("mouseover",((g,y,v)=>b=>{b.preventDefault(),g.drag&&g.noteOn(y,v,127)})(this,l,d)),p.addEventListener("mouseout",((g,y,v)=>b=>{b.preventDefault(),g.noteOff(y,v,0)})(this,l,d)),p.addEventListener(i,((g,y,v)=>b=>{b.preventDefault(),g.drag=!1,g.noteOff(y,v,0)})(this,l,d))}break}}h.appendChild(u)}s.appendChild(h),this.intersection.observe(h)}const o=["Ch.","Bank","Program","Vol.","Exp.","Panpot","Pitch","","Rev.",""],r=e.createElement("div");r.className="header";for(const l in this.items){if(!{}.hasOwnProperty.call(this.items,l))continue;const h=e.createElement("div");h.className=this.items[l],h.textContent=o[l],this.items[l]==="keys"&&(h.appendChild(document.createElement("code")),h.appendChild(document.createElement("div"))),r.appendChild(h)}return s.prepend(r),t.appendChild(s),new ResizeObserver(l=>{for(const h in this.items)!{}.hasOwnProperty.call(this.items,h)||(t.querySelector(`.header .${this.items[h]}`).style.width=t.querySelector(`.channel .${this.items[h]}`).offsetWidth+"px");t.querySelector(".header .keys").style.display=document.documentElement.clientWidth<=680?"none":"flex"}).observe(t),t}updateSynthElement(e,t,s){if(!this.element)return;const n=this.element.querySelectorAll(".instrument > .channel")[e];if(n.dataset.isIntersecting){const i=n.querySelector(`.key:nth-child(${t+1})`);s===0?(i.classList.contains("note-on")&&i.classList.remove("note-on"),i.style.opacity=1):(i.classList.add("note-on"),i.style.opacity=(s/127).toFixed(2))}}updateBankSelect(e){if(!this.element)return;const t=this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".bank > select");for(;t.firstChild;)t.removeChild(t.firstChild);for(const s in this.programSet){if(!{}.hasOwnProperty.call(this.programSet,s))continue;const n=document.createElement("option");n.value=s,n.textContent=("000"+parseInt(s)).slice(-3),s===this.channelBank[e]&&(n.selected="selected"),t.appendChild(n)}}updateProgramSelect(e){const t=this.element.querySelectorAll(".instrument > .channel")[e],s=this.channelBank[e],n=t.querySelector(".bank > select"),i=t.querySelector(".program > select");for(n.value=this.channelBank[e];i.firstChild;)i.removeChild(i.firstChild);for(const o in this.programSet[s]){if(!{}.hasOwnProperty.call(this.programSet[s],o))continue;const r=document.createElement("option");r.value=o,r.textContent=`${("000"+(parseInt(o)+1)).slice(-3)}:${this.programSet[s][o]}`,o===this.channelInstrument[e]&&(r.selected="selected"),i.appendChild(r)}}noteOn(e,t,s=100){const n=this.channelBank[e],i=typeof this.bankSet[n]=="object"?this.bankSet[n]:this.bankSet[0];let o;if(typeof i[this.channelInstrument[e]]=="object"?o=i[this.channelInstrument[e]]:this.percussionPart[e]?o=this.bankSet[this.mode==="XG"?127:128][0]:o=this.bankSet[0][this.channelInstrument[e]],o[t]===void 0)return;const r=o[t];let c=this.channelPanpot[e]===0?Math.floor(Math.random()*127):this.channelPanpot[e]-64;c/=c<0?64:63,r.channel=e,r.key=t,r.velocity=s,r.panpot=c,r.volume=this.channelVolume[e]/127,r.pitchBend=this.channelPitchBend[e]-8192,r.expression=this.channelExpression[e],r.pitchBendSensitivity=Math.round(this.channelPitchBendSensitivity[e]),r.mute=this.channelMute[e],r.releaseTime=this.channelRelease[e],r.cutOffFrequency=this.cutOffFrequency[e],r.harmonicContent=this.harmonicContent[e],r.reverb=this.reverb[e],r.modulation=this.modulation[e],n>=127&&((t===42||t===44)&&this.noteOff(e,46),t===80&&this.noteOff(e,81),o.volume*=this.percussionVolume[t]/127);const l=new Y(this.ctx,this.gainMaster,r);l.noteOn(),this.currentNoteOn[e].push(l),this.updateSynthElement(e,t,s)}noteOff(e,t){let s,n;const i=this.currentNoteOn[e];let o;const r=this.channelHold[e];for(s=0,n=i.length;s<n;++s)o=i[s],o.key===t&&(o.noteOff(),r||(o.release(),i.splice(s,1),--s,--n));this.updateSynthElement(e,t,0)}hold(e,t){const s=this.currentNoteOn[e],n=this.channelHold[e]=t>64;let i,o,r;if(!n)for(o=0,r=s.length;o<r;++o)i=s[o],i.isNoteOff()&&(i.release(),s.splice(o,1),--o,--r);if(this.element){const c=this.element.querySelectorAll(".instrument > .channel")[e];if(!c)return;this.channelHold[e]?c.classList.add("hold"):c.classList.contains("hold")&&c.classList.remove("hold")}}bankSelectMsb(e,t){if(this.percussionPart[e]=t>=125,this.mode==="XG")this.channelBank[e]=0,t===64?this.channelBank[e]=125:t===126||t===127?this.channelBank[e]=t:t===128&&(this.channelBank[e]=127);else if(this.mode==="GS"||this.mode==="GM2")this.channelBank[e]=e===9?128:t,this.percussionPart[e]=t===128;else return;this.updateBankSelect(e)}bankSelectLsb(e,t){this.mode==="XG"&&(this.percussionPart[e]=t>=125,this.channelBank[e]=t,this.updateBankSelect(e))}programChange(e,t){this.channelInstrument[e]=t,this.bankChange(e,this.channelBank[e]),this.element&&(this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".program > select").value=t)}bankChange(e,t){const s=this.mode==="GS"?128:127;this.mode==="GM"&&(t=0),e===9&&(t=s),this.bankSet[t]?this.channelBank[e]=t:this.channelBank[e]=this.percussionPart[e]?s:0,this.element&&(this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".bank > select").value=t),this.updateProgramSelect(e)}volumeChange(e,t){this.element&&(this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".volume var").innerText=t),this.channelVolume[e]=t}expression(e,t){let s,n;const i=this.currentNoteOn[e];for(s=0,n=i.length;s<n;++s)i[s].updateExpression(t);this.element&&(this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".expression var").innerText=t),this.channelExpression[e]=t}panpotChange(e,t){if(this.channelPanpot[e]=t,this.element){const s=this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".panpot .progress-bar"),n=t/127*100;if(s.style.width=`${n}%`,s.classList.remove("left","right"),s.title=t,t===64)return;s.classList.add([t<63?"left":"right"])}}pitchBend(e,t,s){const n=t&127|(s&127)<<7;let i,o;const r=this.currentNoteOn[e],c=n-8192;for(i=0,o=r.length;i<o;++i)r[i].updatePitchBend(c);if(this.channelPitchBend[e]=n,this.element){const l=this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".pitchBend .progress-bar");if(l.style.width=`${Math.floor(n/16384*100)}%`,l.title=c,l.classList.remove("high","low"),c===0)return;l.classList.add(c<0?"low":"high")}}pitchBendSensitivity(e,t){this.element&&(this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".pitchBendSensitivity > var").innerText=t),this.channelPitchBendSensitivity[e]=t}attackTime(e,t){this.channelAttack[e]=t}decayTime(e,t){this.channelDecay[e]=t}sustinTime(e,t){this.channelSustin[e]=t}releaseTime(e,t){this.channelRelease[e]=t}harmonicContent(e,t){this.channelHarmonicContent[e]=t}cutOffFrequency(e,t){this.channelCutOffFrequency[e]=t}reverbDepth(e,t){this.reverb[e].mix(t/127),this.element&&(this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".reverbDepth var").innerText=t)}modulationDepth(e,t){if(this.element){const s=this.element.querySelectorAll(".instrument > .channel")[e].querySelector(".pitchBend .progress-bar");t!==0?s.classList.add(["progress-bar-striped"]):s.classList.remove(["progress-bar-striped"])}this.modulation[e]=t}getPitchBendSensitivity(e){return this.channelPitchBendSensitivity[e]}drumInstrumentLevel(e,t){this.percussionVolume[e]=t}allNoteOff(e){const t=this.currentNoteOn[e];for(this.hold(e,0);t.length>0;)this.noteOff(e,t[0].key,0)}allSoundOff(e){const t=this.currentNoteOn[e];let s;for(;t.length>0;)s=t.shift(),this.noteOff(e,s.key,0),s.release(),s.disconnect();this.hold(e,0)}resetAllControl(e){this.allNoteOff(e),this.expression(e,127),this.pitchBend(e,0,64)}mute(e,t){const s=this.currentNoteOn[e];let n,i;if(this.channelMute[e]=t,t)for(n=0,i=s.length;n<i;++n)s[n].disconnect();else for(n=0,i=s.length;n<i;++n)s[n].connect()}setPercussionPart(e,t){this.mode==="GS"||this.mode==="GM2"?this.channelBank[e]=128:this.channelBank[e]=127,this.percussionPart[e]=t,this.updateBankSelect(e)}processMidiMessage(e){clearTimeout(this.timer);const t=this.element.querySelector(".header .keys code");t.innerText=e.map(s=>String.fromCharCode(s)).join(""),this.timer=setTimeout(()=>{t.innerText=""},5e4)}}class D{static CACHE_NAME="wml";constructor(e,t,s,n){this.url=e,this.cache=s,this.callback=n,this.alert=document.createElement("div"),this.alert.className="alert alert-warning",this.message=document.createElement("p"),this.message.innerText="Now Loading...",this.progressOuter=document.createElement("div"),this.progressOuter.className="progress",this.progress=document.createElement("div"),this.progress.className="progress-bar",this.progressOuter.appendChild(this.progress),this.alert.appendChild(this.message),this.alert.appendChild(this.progressOuter),t.appendChild(this.alert)}onProgress(e,t){const s=Math.floor(e/t*100);this.progress&&(this.progress.style.width=s+"%",this.progress.innerText=s+" %"),requestAnimationFrame(this.onProgress)}onComplete(e){this.alert.className="alert alert-info",this.message.innerText="Initializing...",this.progress.className="progress-bar progress-bar-striped progress-bar-animated",this.progress.style.width="100%",requestAnimationFrame(this.onComplete);const t=new Uint8Array(e);this.callback(t)}onError(e){throw this.alert.className="alert alert-danger",this.message.innerText="An error occurred while loading SoundFont. See the console log for details. In addition, it may be cured by deleting the cache of the browser.",this.progressOuter.style.display="none",requestAnimationFrame(this.onError),Error(e)}async fetch(){const e=await window.caches.open(D.CACHE_NAME),t=await e.match(this.url);if(this.cache&&t){this.onComplete(await t.arrayBuffer());return}const s=await fetch(this.url,{method:"GET",mode:"no-cors",credentials:"include",headers:{"Access-Control-Allow-Origin":"*"}}),n=s.clone(),i=parseInt(s.headers.get("Content-Length")),o=n.body.getReader();let r=0;const c=[];for(;;){const{done:m,value:u}=await o.read();if(m)break;c.push(u),r+=u.length,this.message.innerText=`Now Loading... (${r} of ${i} byte)`,this.onProgress(r,i)}const l=new Uint8Array(r);let h=0;for(const m of c)l.set(m,h),h+=m.length;s.ok&&e.put(this.url,s),this.onComplete(l)}}class X{constructor(e={}){this.NrpnMsb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.NrpnLsb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.RpnMsb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.RpnLsb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.ready=!1,this.synth=void 0,this.loadCallback=void 0,this.messageHandler=this.onmessage.bind(this),this.rpnMode=!0,this.option=e,this.option.drawSynth=e.drawSynth!==void 0?e.drawSynth:!0,this.option.cache=e.cache||!1,this.placeholder=e.placeholder!==void 0?document.getElementById(e.placeholder):window.document.body,this.window=null,window.opener?this.window=window.opener:window.parent!==window?this.window=window.parent:this.window=window}async setup(e){await new D(e,this.placeholder,this.option.cache,s=>this.setupByBuffer(s)).fetch()}setupByBuffer(e){for(;this.placeholder.firstChild;)this.placeholder.removeChild(this.placeholder.firstChild);if(this.synth?this.synth.refreshInstruments(e):(this.synth=new ye(e),this.synth.start()),this.option.drawSynth)this.placeholder.appendChild(this.synth.drawSynth());else{const t=document.createElement("strong");t.innerText="Ready.",this.placeholder.appendChild(t)}this.synth.init(),this.onReady()}onReady(){window.removeEventListener("message",this.messageHandler),this.loadCallback&&this.loadCallback(),window.addEventListener("message",this.messageHandler,!1),this.window.postMessage("link,ready","*")}onmessage(e){const t=typeof e.data.split=="function"?e.data.split(","):[],s=t!==[]?t.shift():"";let n;switch(s){case"midi":this.processMidiMessage(t.map(i=>parseInt(i,16)));break;case"link":if(this.window===void 0)return;switch(n=t.shift(),n){case"reqpatch":this.window.postMessage("link,patch","*");break;case"setpatch":case"ready":this.window.postMessage("link,ready","*");break;case"progress":this.window.postMessage("link,progress","*");break;default:break}break;default:}}setLoadCallback(e){this.loadCallback=e}processMidiMessage(e){const t=e[0]&15,s=this.synth;switch(e[0]&240){case 128:s.noteOff(t,e[1],e[2]);break;case 144:e[2]>0?s.noteOn(t,e[1],e[2]):s.noteOff(t,e[1],0);break;case 176:{const n=e[2];switch(e[1]){case 0:s.bankSelectMsb(t,n);break;case 1:s.modulationDepth(t,n);break;case 5:break;case 6:if(this.rpnMode)switch(this.RpnMsb[t]){case 0:switch(this.RpnLsb[t]){case 0:s.pitchBendSensitivity(t,n);break}break}else switch(this.NrpnMsb[t]){case 26:s.drumInstrumentLevel(this.NrpnLsb[t],n);break}break;case 38:if(this.rpnMode)switch(this.RpnMsb[t]){case 0:switch(this.RpnLsb[t]){case 0:s.pitchBendSensitivity(t,s.getPitchBendSensitivity(t)+n/100);break}break}break;case 7:s.volumeChange(t,n);break;case 10:s.panpotChange(t,n);break;case 120:s.allSoundOff(t);break;case 121:s.resetAllControl(t);break;case 32:s.bankSelectLsb(t,n);break;case 71:s.harmonicContent(t,n);break;case 96:break;case 97:break;case 98:this.rpnMode=!1,this.NrpnLsb[t]=n;break;case 99:this.rpnMode=!1,this.NrpnMsb[t]=n;break;case 100:this.rpnMode=!0,this.RpnLsb[t]=n;break;case 101:this.rpnMode=!0,this.RpnMsb[t]=n;break;case 64:s.hold(t,n);break;case 11:s.expression(t,n);break;case 72:s.decayTime(t,n);break;case 73:s.releaseTime(t,n);break;case 74:s.attackTime(t,n);break;case 75:s.cutOffFrequency(t,n);break;case 91:s.reverbDepth(t,n);break}break}case 192:s.programChange(t,e[1]);break;case 224:s.pitchBend(t,e[1],e[2]);break;case 240:{const n=e[2],i=e[3],o=e[4];if(n===126||i===9)switch(o){case 1:s.init("GM");break;case 2:break;case 3:s.init("GM2");break;default:}else if(n===127)e[4]===1&&s.setMasterVolume(e[5]+(e[6]<<7));else if(n===65){const r=e[7]-15;switch(e[8]){case 0:if(e[7]===0){const c=e.splice(8);c.pop(),c.pop(),s.processMidiMessage(c)}break;case 4:s.setMasterVolume(e[9]*64);break;case 21:{const c=e[8];r===0?s.setPercussionPart(9,c!==0):r>=10?s.setPercussionPart(r-1,c!==0):s.setPercussionPart(r,c!==0);break}case 25:break;case 48:break;case 56:break;case 69:break;case 127:s.init("GS");break;default:}}else if(n==67)switch(e[2]!==67&&e[3]===67&&e.splice(1,1),e[5]){case 0:e[7]===126&&s.init("XG");break;case 2:break;case 4:s.setMasterVolume(e[9]*64);break;case 6:{const r=e.splice(8);r.pop(),s.processMidiMessage(r);break}case 7:break;case 8:s.setPercussionPart(e[6],e[8]!==0);break;default:}break}default:s.setPercussionPart(9,!0);break}}dumpMessage(e){const t=[];for(const s of e)t.push(s.toString(16).toUpperCase());return t.join(" ")}}class be extends X{constructor(e={}){super(e),this.midi=void 0}async setup(e){this.midi=await navigator.requestMIDIAccess({sysex:!0}),await super.setup(e)}onReady(){super.loadCallback&&super.loadCallback(),this.midi.onmidimessage=e=>super.processMidiMessage(e)}}const Z={version:"0.4.12",date:"2022-11-06T12:54:38.672Z"},q={version:Z.version,build:Z.date,WebMidiLink:X,WebMidiApi:be,Parser:W};window.SoundFont||(window.SoundFont=q);const B=document.getElementById("file"),_=document.getElementById("drop"),ve=document.getElementById("build"),ke=document.getElementById("name");window.addEventListener("DOMContentLoaded",async()=>{const a=K.parse(window.location.search),e={placeholder:"placeholder"};a.ui==="false"&&(e.drawSynth=!1);const t=new q.WebMidiLink(e);ve.innerText=new Date(q.build).toLocaleString();const s=a.soundfont?a.soundfont:{VITE_GOOGLE_ANALYTICS_ID:"UA-33600926-1",VITE_WML_URL:"https://logue.dev/sf2synth.js/wml.html?soundfont=Yamaha XG Sound Set Ver.2.0.sf2",BASE_URL:"./",MODE:"production",DEV:!1,PROD:!0}.VITE_SOUNDFONT_URL||"./Yamaha XG Sound Set.sf2";ke.innerText=s.match(/^http/)?new URL(s).pathname.substring(s.lastIndexOf("/")+1):s,await t.setup(s);const n=i=>{const o=new FileReader;o.readAsArrayBuffer(i),o.onload=r=>{document.getElementById("soundfont").innerText=i.name;const c=new Uint8Array(r.target.result);t.setupByBuffer(c)}};B.addEventListener("change",i=>{i.preventDefault(),n(B.files[0]),B.value=""}),_.addEventListener("dragover",i=>i.preventDefault(),!0),_.addEventListener("drop",i=>{const r=i.dataTransfer.files;i.stopPropagation(),i.preventDefault(),n(r[0])},!0)},!1);((a,e,t,s,n)=>{a[s]=a[s]||[],a[s].push({"gtm.start":new Date().getTime(),event:"gtm.js"});const i=e.getElementsByTagName(t)[0],o=e.createElement(t),r=s!="dataLayer"?"&l="+s:"";o.async=!0,o.src="https://www.googletagmanager.com/gtm.js?id="+n+r,i.parentNode.insertBefore(o,i)})(window,document,"script","dataLayer","UA-33600926-1");
